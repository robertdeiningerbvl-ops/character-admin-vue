import{w as ue,a as ce,_ as me,z as he,n as Ve,m as Ue}from"./DiI9-bkE.js";import{_ as we}from"./xC7ZNHnZ.js";import{_ as fe}from"./BkseHKFx.js";import{_ as be}from"./oJBVUttf.js";import{_ as ke}from"./Bml5z8l2.js";import{m as Ie,n as ye,g as Ce,o as Se,a as je,s as Ne}from"./DXr9T7Lu.js";import{p as ge,z as m,A as y,Q as e,u as s,a7 as o,a2 as v,a5 as V,a6 as h,W as ee,a3 as ze,R as C,ah as de,ae as oe,a1 as J,c as Y,h as A,j as _e,an as Re,i as te,ar as Ee,as as Ae,a8 as ve,w as Be,r as De}from"./Cp_GvCOL.js";import{_ as xe}from"./_BOBmhmt.js";import{_ as $e}from"./8gEztUrL.js";import{g as Oe}from"./adOTzFDE.js";import{_ as Te}from"./DwJuNt-9.js";import"./CM1DIlR0.js";import"./B3KMLFeu.js";import"./BlLzDdHJ.js";import"./C-fFc4Sm.js";import"./D7PB4JkZ.js";import"./DZaB2s8a.js";import"./7ga_NNx6.js";import"./_eNQqsN0.js";import"./B9BvCEkO.js";import"./DVCf4JVd.js";import"./DnWsfCtc.js";import"./DaMwIZ4f.js";import"./BnfZ4xmv.js";import"./CangPKqO.js";import"./C8Jf-TuN.js";const Pe={class:"flex gap-6 p-6 h-full min-h-0"},Ge={class:"w-72 shrink-0 flex flex-col"},Le={key:0,class:"flex-1 min-h-[500px] rounded-2xl bg-gray-100 dark:bg-gray-800 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-700 transition-all hover:border-gray-400 dark:hover:border-gray-600"},Me={class:"flex-1 min-h-[500px] rounded-[2rem] border-[6px] border-gray-800 dark:border-gray-900 bg-gray-800 shadow-2xl overflow-hidden flex flex-col"},Je={key:0,class:"absolute inset-0 bg-gradient-to-b from-cyan-100 to-cyan-50 dark:from-gray-700 dark:to-gray-800"},qe={class:"relative z-10 flex items-center justify-center px-4 py-3 bg-black/40 backdrop-blur-sm shrink-0"},Fe={class:"text-center"},He={class:"font-medium text-white text-sm drop-shadow-md"},We={key:0,class:"flex items-center justify-center h-full"},Qe=["src"],Ke={key:1,class:"w-full rounded-lg overflow-hidden"},Ye=["srcdoc"],Xe={key:2,class:"w-full"},Ze={class:"bg-white/80 backdrop-blur rounded-lg p-2 text-sm text-gray-700 mb-2"},et={class:"rounded-lg overflow-hidden"},tt=["srcdoc"],st={key:0},at=["innerHTML"],lt={key:2,class:"flex justify-start"},rt=["src"],ot={class:"bg-white/80 backdrop-blur rounded-lg p-3 text-sm text-gray-700 leading-relaxed max-w-[75%]"},nt={key:3,class:"flex items-center justify-center h-full"},it={class:"relative z-10 p-3 bg-white/60 dark:bg-gray-900/60 backdrop-blur-sm"},dt={class:"flex items-center gap-2"},ut={class:"w-9 h-9 rounded-full bg-cyan-500 flex items-center justify-center text-white shadow-md"},ct={class:"flex-1 space-y-6 overflow-auto pr-2"},mt={class:"flex gap-5"},gt={class:"flex-1"},pt=["src"],xt={class:"w-44"},yt=["src"],vt={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl space-y-4"},ft={class:"flex items-center justify-between"},bt={class:"flex items-center gap-6"},kt={class:"flex items-center gap-2 cursor-pointer"},wt={class:"flex items-center gap-2 cursor-pointer"},ht={class:"flex items-center gap-2 cursor-pointer"},_t={key:0,class:"flex items-center gap-3"},$t={class:"flex gap-3"},Vt=["disabled"],Ut={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},It={class:"flex items-center gap-2 mb-4"},Ct={class:"grid grid-cols-5 gap-3"},St={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},jt={class:"text-2xl font-bold text-primary-600 dark:text-primary-400"},Nt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},zt={class:"text-xl font-semibold text-gray-700 dark:text-gray-300"},Rt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Et={class:"text-xl font-semibold text-gray-700 dark:text-gray-300"},At={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Bt={class:"text-xl font-semibold text-gray-700 dark:text-gray-300"},Dt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Ot={class:"text-xl font-semibold text-gray-700 dark:text-gray-300"},Tt={key:0,class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Pt={class:"flex items-center gap-2 mb-4"},Gt={class:"grid grid-cols-4 gap-3 mb-3"},Lt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Mt={class:"text-xl font-semibold text-orange-500"},Jt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},qt={class:"text-xl font-semibold text-pink-500"},Ft={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Ht={class:"text-xl font-semibold text-blue-500"},Wt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Qt={class:"text-xl font-semibold text-green-500"},Kt={class:"grid grid-cols-4 gap-3"},Yt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},Xt={class:"text-xl font-semibold text-purple-500"},Zt={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},es={class:"text-xl font-semibold text-cyan-500"},ts={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},ss={class:"text-xl font-semibold text-yellow-500"},as={class:"p-3 bg-white dark:bg-gray-900 rounded-lg text-center shadow-sm"},ls={class:"text-xl font-semibold text-gray-600 dark:text-gray-400"},rs={key:1,class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},os={class:"flex items-center gap-2 mb-4"},ns={class:"flex flex-wrap gap-2"},is=ge({__name:"Overview",props:{state:{}},emits:["update:state","save"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:d=>P("update:state",d)}),U=A(!1),F=A(!1),r=A([]),N=A(null),_=d=>/<[^>]+>/.test(d||""),q=d=>{if(!d)return{kind:"text",html:""};if(/<!DOCTYPE|<html[^>]*>|<head[^>]*>|<body[^>]*>/i.test(d)){const b=d.match(/(<!DOCTYPE[\s\S]*|<html[\s\S]*)/i);return b&&b.index!==void 0&&b.index>0?{kind:"mixed",text:d.slice(0,b.index).replace(/<!--[\s\S]*?-->/g,"").replace(/```html\s*$/gm,"").replace(/<\/?content>/gi,"").trim(),html:b[0]}:{kind:"iframe",html:d}}return _(d)?{kind:"html",html:d}:{kind:"text",html:""}},L=async()=>{if(!t.value.amusementId){r.value=[];return}F.value=!0;try{const{data:d}=await Ie({biz_id:t.value.amusementId,version_id:t.value.editingVersionId}),a=d?.history||[];Array.isArray(a)&&a.length>0?r.value=a.map(b=>{const k=q(b.content||"");return{role:b.role||"assistant",raw:b.content||"",kind:k.kind,html:k.html,text:k.text||""}}):r.value=[]}catch{r.value=[]}finally{F.value=!1}},T=async()=>{U.value=!0,await L()},G=A(!1),S=A(!1),x=A(!1),B=A(null),E=A(null),u=async d=>{const a=d.target.files?.[0];if(a){G.value=!0;try{const b=new FormData;b.append("image",a);const{data:k}=await he(b);k?.uri&&(t.value.backgroundImage=k.uri,R.add({title:"上传成功",color:"success"}))}catch(b){R.add({title:b.message||"上传失败",color:"error"})}finally{G.value=!1,d.target.value=""}}},l=async d=>{const a=d.target.files?.[0];if(a){S.value=!0;try{const b=new FormData;b.append("image",a);const{data:k}=await he(b);k?.uri&&(t.value.avatarImage=k.uri,R.add({title:"上传成功",color:"success"}))}catch(b){R.add({title:b.message||"上传失败",color:"error"})}finally{S.value=!1,d.target.value=""}}},g=Y(()=>t.value.avatarImage||t.value.backgroundImage),c=d=>{if(!d)return 0;const a=(d.match(/[\u4e00-\u9fa5]/g)||[]).length,b=d.length-a;return Math.ceil(a/2+b/4)},w=Y(()=>{const d=[t.value.name,t.value.description,t.value.personality,t.value.scenario,t.value.mesExample,t.value.systemPrompt,t.value.creatorNotes,...t.value.greetings].join(""),a=c(d),b=t.value.worldBookEntries.map(W=>`${(W.keys||[]).join(",")}${W.content||""}`).join(""),k=c(b),H=t.value.regexEntries.map(W=>`${W.scriptName}${W.findRegex}${W.replaceString}`).join(""),re=c(H),f=t.value.quickReplies.map(W=>W.content).join(""),$=c(f);return{total:a+k+re+$,settings:a,worldBook:t.value.worldBookEntries.length,regex:t.value.regexEntries.length,guide:t.value.quickReplies.filter(W=>(W.content||"").trim()).length}}),M=()=>({spec:"chara_card_v2",spec_version:"2.0",name:t.value.name,anohana:{image:t.value.backgroundImage,avatar:t.value.avatarImage||t.value.backgroundImage,source:t.value.isRepost,source_url:t.value.sourceUrl,summary:t.value.summary,anonymous:t.value.isPrivate,nsfw:t.value.isNsfw,guide:t.value.quickReplies.filter(d=>(d.content||"").trim())},data:{name:t.value.name,description:t.value.description,personality:t.value.personality,scenario:t.value.scenario,mes_example:t.value.mesExample,first_mes:t.value.greetings[0]||"",alternate_greetings:t.value.greetings.slice(1),creator_notes:t.value.creatorNotes,system_prompt:t.value.systemPrompt,creator:t.value.creatorName,tags:t.value.tags,character_book:t.value.worldBookEntries.length>0?{name:t.value.worldBookName||`${t.value.name}的世界书`,entries:t.value.worldBookEntries}:void 0,regex:t.value.regexEntries.length>0?t.value.regexEntries:void 0}}),j=()=>{if(!t.value.description?.trim()){R.add({title:"请先填写角色描述",color:"error"});return}const d=M(),a=JSON.stringify(d,null,2),b=new Blob([a],{type:"application/json"}),k=URL.createObjectURL(b),H=document.createElement("a");H.href=k,H.download=`${t.value.name||"character"}.json`,H.click(),URL.revokeObjectURL(k),R.add({title:"JSON 导出成功",color:"success"})},n=async()=>{if(!t.value.backgroundImage){R.add({title:"请先上传背景图",color:"error"});return}if(!t.value.description?.trim()){R.add({title:"请先填写角色描述",color:"error"});return}x.value=!0;try{const d=M(),a=JSON.stringify(d),b=btoa(unescape(encodeURIComponent(a))),k=new Image;k.crossOrigin="anonymous",await new Promise((z,K)=>{k.onload=()=>z(),k.onerror=()=>K(new Error("图片加载失败")),k.src=t.value.backgroundImage});const H=document.createElement("canvas");H.width=k.naturalWidth,H.height=k.naturalHeight,H.getContext("2d").drawImage(k,0,0);const f=H.toDataURL("image/png"),$=atob(f.split(",")[1]),W=new Uint8Array($.length);for(let z=0;z<$.length;z++)W[z]=$.charCodeAt(z);const Q=D(W,"chara",b),p=new Blob([Q],{type:"image/png"}),i=URL.createObjectURL(p),O=document.createElement("a");O.href=i,O.download=`${t.value.name||"character"}.png`,O.click(),URL.revokeObjectURL(i),R.add({title:"PNG 导出成功",color:"success"})}catch(d){R.add({title:d.message||"导出失败",color:"error"})}finally{x.value=!1}},D=(d,a,b)=>{const k=[];for(let ae=0;ae<256;ae++){let X=ae;for(let ie=0;ie<8;ie++)X=X&1?3988292384^X>>>1:X>>>1;k[ae]=X}const H=ae=>{let X=4294967295;for(let ie=0;ie<ae.length;ie++)X=k[(X^ae[ie])&255]^X>>>8;return(X^4294967295)>>>0},re=new TextEncoder().encode(a),f=new TextEncoder().encode(b),$=new Uint8Array(re.length+1+f.length);$.set(re,0),$[re.length]=0,$.set(f,re.length+1);const W=new TextEncoder().encode("tEXt"),Q=$.length,p=new Uint8Array(8+Q+4);p[0]=Q>>24&255,p[1]=Q>>16&255,p[2]=Q>>8&255,p[3]=Q&255,p.set(W,4),p.set($,8);const i=new Uint8Array(4+Q);i.set(W,0),i.set($,4);const O=H(i);p[8+Q]=O>>24&255,p[8+Q+1]=O>>16&255,p[8+Q+2]=O>>8&255,p[8+Q+3]=O&255;let z=8;for(;z<d.length-12;){const ae=d[z]<<24|d[z+1]<<16|d[z+2]<<8|d[z+3],X=String.fromCharCode(d[z+4],d[z+5],d[z+6],d[z+7]);if(z+=12+ae,X==="IHDR")break}const K=new Uint8Array(d.length+p.length);return K.set(d.slice(0,z),0),K.set(p,z),K.set(d.slice(z),z+p.length),K};return(d,a)=>{const b=ce,k=me,H=fe,re=be,f=ke;return m(),y("div",Pe,[e("div",Ge,[s(U)?(m(),y(ee,{key:1},[e("div",Me,[e("div",{class:"flex-1 min-h-0 flex flex-col relative",style:ze({backgroundImage:s(t).backgroundImage?`url(${s(t).backgroundImage})`:void 0,backgroundSize:"cover",backgroundPosition:"center"})},[s(t).backgroundImage?C("",!0):(m(),y("div",Je)),e("div",qe,[e("div",Fe,[e("div",He,h(s(t).name||"未命名角色"),1),a[10]||(a[10]=e("div",{class:"text-xs text-cyan-300 flex items-center justify-center gap-1 mt-0.5"},[e("span",{class:"w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"}),V(" 24小时在线 ")],-1))])]),e("div",{ref_key:"chatContentRef",ref:N,class:"flex-1 min-h-0 relative z-10 p-3 overflow-y-auto space-y-3"},[s(F)?(m(),y("div",We,[...a[11]||(a[11]=[e("span",{class:"text-gray-400 text-sm"},"加载聊天记录中...",-1)])])):s(r).length>0?(m(!0),y(ee,{key:1},de(s(r),($,W)=>(m(),y("div",{key:W,class:oe(["flex",$.kind==="iframe"||$.kind==="mixed"?"w-full":$.role==="user"?"justify-end":"justify-start"])},[$.role!=="user"&&$.kind!=="iframe"&&$.kind!=="mixed"&&s(g)?(m(),y("img",{key:0,src:s(g),alt:"",class:"w-8 h-8 rounded-full mr-2 shrink-0 object-cover"},null,8,Qe)):C("",!0),$.kind==="iframe"?(m(),y("div",Ke,[e("iframe",{class:"w-full border-0",style:{"min-height":"300px"},srcdoc:$.html,sandbox:"allow-scripts allow-same-origin allow-modals",onLoad:a[0]||(a[0]=Q=>{const p=Q.target;try{const i=p.contentWindow?.document?.body?.scrollHeight||300;p.style.height=i+"px"}catch{}})},null,40,Ye)])):$.kind==="mixed"?(m(),y("div",Xe,[e("div",Ze,h($.text),1),e("div",et,[e("iframe",{class:"w-full border-0",style:{"min-height":"300px"},srcdoc:$.html,sandbox:"allow-scripts allow-same-origin allow-modals",onLoad:a[1]||(a[1]=Q=>{const p=Q.target;try{const i=p.contentWindow?.document?.body?.scrollHeight||300;p.style.height=i+"px"}catch{}})},null,40,tt)])])):(m(),y("div",{key:3,class:oe(["max-w-[75%] rounded-lg p-2 text-sm",$.role==="user"?"bg-cyan-500 text-white":"bg-white/80 backdrop-blur text-gray-700"])},[$.kind==="text"?(m(),y("span",st,h($.raw),1)):$.kind==="html"?(m(),y("div",{key:1,class:"message-content",innerHTML:$.html},null,8,at)):C("",!0)],2))],2))),128)):s(t).greetings[0]?(m(),y("div",lt,[s(g)?(m(),y("img",{key:0,src:s(g),alt:"",class:"w-8 h-8 rounded-full mr-2 shrink-0 object-cover"},null,8,rt)):C("",!0),e("div",ot,h(s(t).greetings[0].slice(0,200))+h(s(t).greetings[0].length>200?"...":""),1)])):(m(),y("div",nt,[...a[12]||(a[12]=[e("span",{class:"text-gray-400 text-sm"},"暂无聊天记录",-1)])]))],512),e("div",it,[e("div",dt,[a[13]||(a[13]=e("div",{class:"flex-1 bg-white dark:bg-gray-800 rounded-full px-4 py-2 text-sm text-gray-400"}," 说点什么... ",-1)),e("div",ut,[o(b,{name:"i-lucide-send",class:"w-4 h-4"})])])])],4)]),e("button",{class:"w-full mt-3 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors flex items-center justify-center gap-1.5",onClick:a[2]||(a[2]=$=>U.value=!1)},[o(b,{name:"i-lucide-eye-off",class:"w-3.5 h-3.5"}),a[14]||(a[14]=V(" 关闭预览 ",-1))])],64)):(m(),y("div",Le,[o(b,{name:"i-lucide-eye",class:"w-12 h-12 text-gray-400 mb-4"}),a[9]||(a[9]=e("span",{class:"text-gray-500 dark:text-gray-400 mb-5 text-sm"},"点击预览聊天效果",-1)),o(k,{size:"sm",loading:s(F),onClick:T},{leading:v(()=>[o(b,{name:"i-lucide-eye",class:"w-4 h-4"})]),default:v(()=>[V(" "+h(s(F)?"加载中...":"预览"),1)]),_:1},8,["loading"])]))]),e("div",ct,[e("div",mt,[e("div",gt,[a[17]||(a[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"背景图",-1)),e("div",{class:"h-44 rounded-xl bg-gray-50 dark:bg-gray-800/50 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-700 cursor-pointer hover:border-primary-400 dark:hover:border-primary-500 transition-all overflow-hidden group",onClick:a[3]||(a[3]=$=>!s(G)&&s(B)?.click())},[s(G)?(m(),y(ee,{key:0},[o(b,{name:"i-lucide-loader-2",class:"w-8 h-8 text-gray-400 mb-2 animate-spin"}),a[15]||(a[15]=e("span",{class:"text-sm text-gray-500"},"上传中...",-1))],64)):s(t).backgroundImage?(m(),y("img",{key:1,src:s(t).backgroundImage,alt:"背景",class:"w-full h-full object-cover"},null,8,pt)):(m(),y(ee,{key:2},[o(b,{name:"i-lucide-image-plus",class:"w-10 h-10 text-gray-400 mb-2 group-hover:text-primary-500 transition-colors"}),a[16]||(a[16]=e("span",{class:"text-sm text-gray-500 group-hover:text-primary-500 transition-colors"},"点击上传背景图",-1))],64))])]),e("input",{ref_key:"bgInputRef",ref:B,type:"file",accept:"image/*",class:"hidden",onChange:u},null,544),e("div",xt,[a[20]||(a[20]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"头像",-1)),e("div",{class:"h-44 rounded-xl bg-gray-50 dark:bg-gray-800/50 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-700 cursor-pointer hover:border-primary-400 dark:hover:border-primary-500 transition-all overflow-hidden group",onClick:a[4]||(a[4]=$=>!s(S)&&s(E)?.click())},[s(S)?(m(),y(ee,{key:0},[o(b,{name:"i-lucide-loader-2",class:"w-6 h-6 text-gray-400 mb-1 animate-spin"}),a[18]||(a[18]=e("span",{class:"text-sm text-gray-500"},"上传中...",-1))],64)):s(g)?(m(),y("img",{key:1,src:s(g),alt:"头像",class:"w-full h-full object-cover"},null,8,yt)):(m(),y(ee,{key:2},[o(b,{name:"i-lucide-user-circle",class:"w-10 h-10 text-gray-400 mb-2 group-hover:text-primary-500 transition-colors"}),a[19]||(a[19]=e("span",{class:"text-sm text-gray-500 group-hover:text-primary-500 transition-colors"},"点击上传头像",-1))],64))])]),e("input",{ref_key:"avatarInputRef",ref:E,type:"file",accept:"image/*",class:"hidden",onChange:l},null,544)]),e("div",vt,[e("div",ft,[a[24]||(a[24]=e("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"发布设置",-1)),e("div",bt,[e("label",kt,[a[21]||(a[21]=e("span",{class:"text-sm text-gray-600 dark:text-gray-400"},"转载",-1)),o(H,{modelValue:s(t).isRepost,"onUpdate:modelValue":a[5]||(a[5]=$=>s(t).isRepost=$),size:"sm"},null,8,["modelValue"])]),e("label",wt,[a[22]||(a[22]=e("span",{class:"text-sm text-gray-600 dark:text-gray-400"},"隐私",-1)),o(H,{modelValue:s(t).isPrivate,"onUpdate:modelValue":a[6]||(a[6]=$=>s(t).isPrivate=$),size:"sm"},null,8,["modelValue"])]),e("label",ht,[a[23]||(a[23]=e("span",{class:"text-sm text-gray-600 dark:text-gray-400"},"NSFW",-1)),o(H,{modelValue:s(t).isNsfw,"onUpdate:modelValue":a[7]||(a[7]=$=>s(t).isNsfw=$),size:"sm"},null,8,["modelValue"])])])]),s(t).isRepost?(m(),y("div",_t,[o(b,{name:"i-lucide-link",class:"w-4 h-4 text-gray-400 shrink-0"}),o(re,{modelValue:s(t).sourceUrl,"onUpdate:modelValue":a[8]||(a[8]=$=>s(t).sourceUrl=$),placeholder:"请输入原作品链接...",class:"flex-1"},null,8,["modelValue"])])):C("",!0)]),e("div",$t,[e("button",{class:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-sm text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all shadow-sm",onClick:j},[o(b,{name:"i-lucide-file-json",class:"w-4 h-4 text-blue-500"}),a[25]||(a[25]=V(" 导出 JSON ",-1))]),e("button",{class:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-sm text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all shadow-sm disabled:opacity-50",disabled:s(x),onClick:n},[s(x)?(m(),J(b,{key:0,name:"i-lucide-loader-2",class:"w-4 h-4 animate-spin"})):(m(),J(b,{key:1,name:"i-lucide-image",class:"w-4 h-4 text-green-500"})),V(" "+h(s(x)?"导出中...":"导出 PNG"),1)],8,Vt)]),e("div",Ut,[e("div",It,[o(b,{name:"i-lucide-bar-chart-3",class:"w-4 h-4 text-gray-500"}),a[26]||(a[26]=e("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"Token 统计",-1))]),e("div",Ct,[e("div",St,[e("div",jt,h(s(w).total),1),a[27]||(a[27]=e("div",{class:"text-xs text-gray-500 mt-1"}," 总计 ",-1))]),e("div",Nt,[e("div",zt,h(s(w).settings),1),a[28]||(a[28]=e("div",{class:"text-xs text-gray-500 mt-1"}," 设定 ",-1))]),e("div",Rt,[e("div",Et,h(s(w).worldBook),1),a[29]||(a[29]=e("div",{class:"text-xs text-gray-500 mt-1"}," 世界书 ",-1))]),e("div",At,[e("div",Bt,h(s(w).regex),1),a[30]||(a[30]=e("div",{class:"text-xs text-gray-500 mt-1"}," 正则 ",-1))]),e("div",Dt,[e("div",Ot,h(s(w).guide),1),a[31]||(a[31]=e("div",{class:"text-xs text-gray-500 mt-1"}," 引导词 ",-1))])])]),s(t).amusementId?(m(),y("div",Tt,[e("div",Pt,[o(b,{name:"i-lucide-activity",class:"w-4 h-4 text-gray-500"}),a[32]||(a[32]=e("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"数据统计",-1))]),e("div",Gt,[e("div",Lt,[e("div",Mt,h(s(t).stats.battery),1),a[33]||(a[33]=e("div",{class:"text-xs text-gray-500 mt-1"}," 电量 ",-1))]),e("div",Jt,[e("div",qt,h(s(t).stats.praiseCount),1),a[34]||(a[34]=e("div",{class:"text-xs text-gray-500 mt-1"}," 点赞 ",-1))]),e("div",Ft,[e("div",Ht,h(s(t).stats.collectCount),1),a[35]||(a[35]=e("div",{class:"text-xs text-gray-500 mt-1"}," 收藏 ",-1))]),e("div",Wt,[e("div",Qt,h(s(t).stats.commentCount),1),a[36]||(a[36]=e("div",{class:"text-xs text-gray-500 mt-1"}," 评论 ",-1))])]),e("div",Kt,[e("div",Yt,[e("div",Xt,h(s(t).stats.dialogueCount),1),a[37]||(a[37]=e("div",{class:"text-xs text-gray-500 mt-1"}," 对话数 ",-1))]),e("div",Zt,[e("div",es,h(s(t).stats.playCount),1),a[38]||(a[38]=e("div",{class:"text-xs text-gray-500 mt-1"}," 游玩数 ",-1))]),e("div",ts,[e("div",ss,h(s(t).stats.score),1),a[39]||(a[39]=e("div",{class:"text-xs text-gray-500 mt-1"}," 评分 ",-1))]),e("div",as,[e("div",ls,h(s(t).stats.scoreCount),1),a[40]||(a[40]=e("div",{class:"text-xs text-gray-500 mt-1"}," 评分人数 ",-1))])])])):C("",!0),s(t).amusementId?(m(),y("div",rs,[e("div",os,[o(b,{name:"i-lucide-tags",class:"w-4 h-4 text-gray-500"}),a[41]||(a[41]=e("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"状态标记",-1))]),e("div",ns,[o(f,{color:s(t).amusementState===2?"success":"warning",variant:"soft"},{default:v(()=>[V(h(s(t).amusementState===2?"已发布":s(t).amusementState===0?"待审核":"未通过"),1)]),_:1},8,["color"]),s(t).recommend===2?(m(),J(f,{key:0,color:"primary",variant:"soft"},{default:v(()=>[...a[42]||(a[42]=[V(" 推荐 ",-1)])]),_:1})):C("",!0),s(t).dayRecommend===2?(m(),J(f,{key:1,color:"info",variant:"soft"},{default:v(()=>[...a[43]||(a[43]=[V(" 日推 ",-1)])]),_:1})):C("",!0),s(t).isPrivate?(m(),J(f,{key:2,color:"neutral",variant:"soft"},{default:v(()=>[...a[44]||(a[44]=[V(" 隐私 ",-1)])]),_:1})):C("",!0),s(t).isNsfw?(m(),J(f,{key:3,color:"error",variant:"soft"},{default:v(()=>[...a[45]||(a[45]=[V(" NSFW ",-1)])]),_:1})):C("",!0),s(t).isRepost?(m(),J(f,{key:4,color:"warning",variant:"soft"},{default:v(()=>[...a[46]||(a[46]=[V(" 转载 ",-1)])]),_:1})):C("",!0),s(t).amusementDraft===2?(m(),J(f,{key:5,color:"neutral",variant:"outline"},{default:v(()=>[...a[47]||(a[47]=[V(" 草稿 ",-1)])]),_:1})):C("",!0)])])):C("",!0)])])}}}),ds=Object.assign(is,{__name:"AmusementDetailOverview"}),us={class:"p-6 space-y-6"},cs={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},ms={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-4"},gs={class:"grid grid-cols-2 gap-4 mb-4"},ps={key:0,class:"flex flex-wrap gap-2 mb-3"},xs=["onClick"],ys={class:"flex flex-wrap gap-2 mb-3"},vs=["onClick"],fs={class:"flex gap-2 mb-2"},bs={class:"text-xs text-gray-500"},ks={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},ws={class:"flex items-center justify-between mb-4"},hs={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300"},_s={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},$s={class:"flex items-center justify-between mb-4"},Vs={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300"},Us={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Is={class:"flex items-center justify-between mb-4"},Cs={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300"},Ss={class:"flex items-center justify-between mb-2"},js={class:"flex items-center gap-2"},Ns={class:"text-sm text-gray-600 dark:text-gray-400"},zs={class:"flex items-center gap-1"},Rs={class:"flex items-center gap-3"},Es={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},As={class:"flex items-center justify-between mb-2"},Bs={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Ds={class:"flex items-center justify-between mb-2"},Os={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Ts={class:"flex items-center justify-between mb-2"},Ps={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Gs={class:"flex items-center justify-between mb-2"},Ls={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Ms={class:"flex items-center justify-between mb-2"},Js={class:"flex flex-col h-[80vh]"},qs={class:"flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700"},Fs={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},Hs={class:"flex-1 p-6 overflow-hidden"},Ws=["placeholder"],Qs={class:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700"},pe=10,Ks=ge({__name:"Settings",props:{state:{}},emits:["update:state"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:j=>P("update:state",j)}),U=A(!1),F=A("description"),r=A(""),N={description:"角色描述",summary:"角色简介",firstMes:"第一句话",personality:"个性",scenario:"场景",mesExample:"对话示例",systemPrompt:"系统提示词",creatorNotes:"创作者备注"},_=j=>{F.value=j,r.value=N[j],U.value=!0},q=Y({get:()=>{const j=F.value;return j==="firstMes"?t.value.greetings[t.value.currentGreetingIndex]||"":t.value[j]||""},set:j=>{const n=F.value;n==="firstMes"?t.value.greetings[t.value.currentGreetingIndex]=j:t.value[n]=j}}),L=A(""),T=A([]),G=A([]),S=async()=>{try{const{data:j}=await Oe({page:1,pagesize:50,ty:0,state:2}),D=(j?.list||[]).map(d=>String(d?.name||"").trim()).filter(Boolean);T.value=[...new Set(D)],x()}catch{T.value=[],G.value=[]}},x=()=>{if(!T.value.length)return;const j=[...T.value].sort(()=>Math.random()-.5),n=Math.floor(Math.random()*6)+10;G.value=j.slice(0,n)},B=j=>{t.value.tags.includes(j)?t.value.tags=t.value.tags.filter(n=>n!==j):t.value.tags.length<pe?t.value.tags.push(j):R.add({title:`最多只能添加 ${pe} 个标签`,color:"error"})},E=j=>{t.value.tags=t.value.tags.filter(n=>n!==j)},u=()=>{const j=L.value.trim();if(j){if(t.value.tags.includes(j)){R.add({title:"标签已存在",color:"error"});return}if(t.value.tags.length>=pe){R.add({title:`最多只能添加 ${pe} 个标签`,color:"error"});return}t.value.tags.push(j),L.value=""}},l=A(!1),g=()=>{t.value.currentGreetingIndex>0&&t.value.currentGreetingIndex--},c=()=>{t.value.currentGreetingIndex<t.value.greetings.length-1&&t.value.currentGreetingIndex++},w=()=>{t.value.greetings.push(""),t.value.currentGreetingIndex=t.value.greetings.length-1},M=()=>{t.value.greetings.length>1&&(t.value.greetings.splice(t.value.currentGreetingIndex,1),t.value.currentGreetingIndex>=t.value.greetings.length&&(t.value.currentGreetingIndex=t.value.greetings.length-1))};return _e(()=>{S()}),(j,n)=>{const D=ce,d=be,a=me,b=xe,k=ke,H=fe,re=$e;return m(),y("div",us,[n[43]||(n[43]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-gray-100"}," 角色设定详细信息 ",-1)),e("div",cs,[e("div",ms,[o(D,{name:"i-lucide-settings-2",class:"w-5 h-5"}),n[24]||(n[24]=e("span",{class:"font-medium"},"身份设定",-1))]),e("div",gs,[e("div",null,[n[25]||(n[25]=e("label",{class:"block text-sm text-gray-500 mb-2"},"角色名称",-1)),o(d,{modelValue:s(t).name,"onUpdate:modelValue":n[0]||(n[0]=f=>s(t).name=f),placeholder:"输入角色名称..."},null,8,["modelValue"])]),e("div",null,[n[26]||(n[26]=e("label",{class:"block text-sm text-gray-500 mb-2"},"创作者",-1)),o(d,{modelValue:s(t).creatorName,"onUpdate:modelValue":n[1]||(n[1]=f=>s(t).creatorName=f),placeholder:"输入创作者名称..."},null,8,["modelValue"])])]),e("div",null,[n[28]||(n[28]=e("label",{class:"block text-sm text-gray-500 mb-2"},"标签",-1)),s(t).tags.length>0?(m(),y("div",ps,[(m(!0),y(ee,null,de(s(t).tags,f=>(m(),y("span",{key:f,class:"inline-flex items-center gap-1 px-3 py-1 text-sm rounded-full bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900"},[V(h(f)+" ",1),e("button",{class:"hover:opacity-70",onClick:$=>E(f)},[o(D,{name:"i-lucide-x",class:"w-3 h-3"})],8,xs)]))),128))])):C("",!0),e("div",ys,[e("button",{class:"px-3 py-1 text-sm rounded-full border bg-purple-50 text-purple-600 border-purple-300 hover:bg-purple-100 dark:bg-purple-900/20 dark:text-purple-400 dark:border-purple-700 transition-colors",onClick:x}," 换一批 "),(m(!0),y(ee,null,de(s(G).filter(f=>!s(t).tags.includes(f)),f=>(m(),y("button",{key:f,class:"px-3 py-1 text-sm rounded-full border bg-white text-gray-600 border-gray-300 hover:border-gray-500 dark:bg-gray-900 dark:text-gray-400 dark:border-gray-700 transition-colors",onClick:$=>B(f)},h(f),9,vs))),128))]),e("div",fs,[o(d,{modelValue:s(L),"onUpdate:modelValue":n[2]||(n[2]=f=>te(L)?L.value=f:null),placeholder:"输入自定义标签...",class:"flex-1",onKeyup:Re(u,["enter"])},null,8,["modelValue"]),o(a,{variant:"outline",onClick:u},{leading:v(()=>[o(D,{name:"i-lucide-plus",class:"w-4 h-4"})]),default:v(()=>[n[27]||(n[27]=V(" 添加 ",-1))]),_:1})]),e("p",bs," 最多 "+h(pe)+" 个标签，已选 "+h(s(t).tags.length)+" 个 ",1)])]),e("div",ks,[e("div",ws,[e("div",hs,[o(D,{name:"i-lucide-user",class:"w-5 h-5"}),n[29]||(n[29]=e("span",{class:"font-medium"},"角色描述",-1))]),o(a,{variant:"ghost",size:"xs",onClick:n[3]||(n[3]=f=>_("description"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4 mr-1"}),n[30]||(n[30]=V(" 全屏 ",-1))]),_:1})]),o(b,{modelValue:s(t).description,"onUpdate:modelValue":n[4]||(n[4]=f=>s(t).description=f),placeholder:"详细描述角色的外貌、性格...",rows:6,class:"w-full"},null,8,["modelValue"])]),e("div",_s,[e("div",$s,[e("div",Vs,[o(D,{name:"i-lucide-file-text",class:"w-5 h-5"}),n[31]||(n[31]=e("span",{class:"font-medium"},"角色简介",-1)),n[32]||(n[32]=e("span",{class:"text-xs text-gray-400"},"用于角色卡片展示的简短介绍",-1))]),o(a,{variant:"ghost",size:"xs",onClick:n[5]||(n[5]=f=>_("summary"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4 mr-1"}),n[33]||(n[33]=V(" 全屏 ",-1))]),_:1})]),o(b,{modelValue:s(t).summary,"onUpdate:modelValue":n[6]||(n[6]=f=>s(t).summary=f),placeholder:"简短介绍角色...",rows:4,class:"w-full"},null,8,["modelValue"])]),e("div",Us,[e("div",Is,[e("div",Cs,[o(D,{name:"i-lucide-sparkles",class:"w-5 h-5"}),n[34]||(n[34]=e("span",{class:"font-medium"},"对话行为",-1))]),o(a,{variant:"ghost",size:"xs",onClick:n[7]||(n[7]=f=>_("firstMes"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4 mr-1"}),n[35]||(n[35]=V(" 全屏 ",-1))]),_:1})]),e("div",Ss,[e("div",js,[e("span",Ns,h(s(t).currentGreetingIndex===0?"第一句话 (主)":"备用开场白"),1),o(k,{variant:"soft",size:"xs"},{default:v(()=>[V(h(s(t).currentGreetingIndex+1)+" / "+h(s(t).greetings.length),1)]),_:1})]),e("div",zs,[o(a,{variant:"ghost",size:"xs",disabled:s(t).currentGreetingIndex===0,onClick:g},{default:v(()=>[o(D,{name:"i-lucide-chevron-left",class:"w-4 h-4"})]),_:1},8,["disabled"]),o(a,{variant:"ghost",size:"xs",disabled:s(t).currentGreetingIndex>=s(t).greetings.length-1,onClick:c},{default:v(()=>[o(D,{name:"i-lucide-chevron-right",class:"w-4 h-4"})]),_:1},8,["disabled"]),o(a,{variant:"ghost",size:"xs",onClick:w},{default:v(()=>[o(D,{name:"i-lucide-plus",class:"w-4 h-4"})]),_:1}),o(a,{variant:"ghost",size:"xs",color:"error",disabled:s(t).greetings.length<=1,onClick:M},{default:v(()=>[o(D,{name:"i-lucide-trash-2",class:"w-4 h-4"})]),_:1},8,["disabled"])])]),o(b,{modelValue:s(t).greetings[s(t).currentGreetingIndex],"onUpdate:modelValue":n[8]||(n[8]=f=>s(t).greetings[s(t).currentGreetingIndex]=f),placeholder:"输入第一句话...",rows:6,class:"w-full"},null,8,["modelValue"])]),e("div",Rs,[n[36]||(n[36]=e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"高级选项",-1)),o(H,{modelValue:s(l),"onUpdate:modelValue":n[9]||(n[9]=f=>te(l)?l.value=f:null)},null,8,["modelValue"])]),s(l)?(m(),y(ee,{key:0},[e("div",Es,[e("div",As,[n[37]||(n[37]=e("label",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"个性 (personality)",-1)),o(a,{variant:"ghost",size:"xs",onClick:n[10]||(n[10]=f=>_("personality"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4"})]),_:1})]),o(b,{modelValue:s(t).personality,"onUpdate:modelValue":n[11]||(n[11]=f=>s(t).personality=f),placeholder:"描述角色的个性特点...",rows:5,class:"w-full"},null,8,["modelValue"])]),e("div",Bs,[e("div",Ds,[n[38]||(n[38]=e("label",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"场景 (scenario)",-1)),o(a,{variant:"ghost",size:"xs",onClick:n[12]||(n[12]=f=>_("scenario"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4"})]),_:1})]),o(b,{modelValue:s(t).scenario,"onUpdate:modelValue":n[13]||(n[13]=f=>s(t).scenario=f),placeholder:"描述角色所处的场景...",rows:5,class:"w-full"},null,8,["modelValue"])]),e("div",Os,[e("div",Ts,[n[39]||(n[39]=e("label",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"对话示例 (mes_example)",-1)),o(a,{variant:"ghost",size:"xs",onClick:n[14]||(n[14]=f=>_("mesExample"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4"})]),_:1})]),o(b,{modelValue:s(t).mesExample,"onUpdate:modelValue":n[15]||(n[15]=f=>s(t).mesExample=f),placeholder:"提供对话示例...",rows:6,class:"w-full"},null,8,["modelValue"])]),e("div",Ps,[e("div",Gs,[n[40]||(n[40]=e("label",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"系统提示词 (system_prompt)",-1)),o(a,{variant:"ghost",size:"xs",onClick:n[16]||(n[16]=f=>_("systemPrompt"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4"})]),_:1})]),o(b,{modelValue:s(t).systemPrompt,"onUpdate:modelValue":n[17]||(n[17]=f=>s(t).systemPrompt=f),placeholder:"系统提示词...",rows:5,class:"w-full"},null,8,["modelValue"])]),e("div",Ls,[e("div",Ms,[n[41]||(n[41]=e("label",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"创作者备注 (creator_notes)",-1)),o(a,{variant:"ghost",size:"xs",onClick:n[18]||(n[18]=f=>_("creatorNotes"))},{default:v(()=>[o(D,{name:"i-lucide-maximize-2",class:"w-4 h-4"})]),_:1})]),o(b,{modelValue:s(t).creatorNotes,"onUpdate:modelValue":n[19]||(n[19]=f=>s(t).creatorNotes=f),placeholder:"创作者备注...",rows:4,class:"w-full"},null,8,["modelValue"])])],64)):C("",!0),o(re,{open:s(U),"onUpdate:open":n[23]||(n[23]=f=>te(U)?U.value=f:null),ui:{width:"max-w-4xl"}},{content:v(()=>[e("div",Js,[e("div",qs,[e("h3",Fs,h(s(r)),1),o(a,{variant:"ghost",size:"sm",onClick:n[20]||(n[20]=f=>U.value=!1)},{default:v(()=>[o(D,{name:"i-lucide-x",class:"w-5 h-5"})]),_:1})]),e("div",Hs,[Ee(e("textarea",{"onUpdate:modelValue":n[21]||(n[21]=f=>te(q)?q.value=f:null),class:"w-full h-full p-4 text-sm bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:`输入${s(r)}...`},null,8,Ws),[[Ae,s(q)]])]),e("div",Qs,[o(a,{variant:"outline",onClick:n[22]||(n[22]=f=>U.value=!1)},{default:v(()=>[...n[42]||(n[42]=[V(" 关闭 ",-1)])]),_:1})])])]),_:1},8,["open"])])}}}),Ys=Object.assign(Ks,{__name:"AmusementDetailSettings"}),Xs={class:"p-6 space-y-6"},Zs={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},ea={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-4"},ta={class:"flex items-center gap-3 mb-4"},sa={class:"space-y-3"},aa={key:0,class:"p-16 text-center text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl"},la=["onClick"],ra={class:"font-medium text-gray-900 dark:text-gray-100 flex-1"},oa={key:0,class:"p-4 border-t border-gray-200 dark:border-gray-700 space-y-4"},na={class:"grid grid-cols-3 gap-4"},ia={class:"pt-4 border-t border-gray-100 dark:border-gray-800"},da={class:"space-y-2"},ua={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},ca={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},ma={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},ga={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},pa={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},xa={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},ya={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},va=ge({__name:"Worldbook",props:{state:{}},emits:["update:state"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:u=>P("update:state",u)}),U=A(new Set),F=u=>{U.value.has(u)?U.value.delete(u):U.value.add(u)},r=()=>{const u=Date.now();t.value.worldBookEntries.push({id:u,keys:[],secondary_keys:[],content:"",comment:"",enabled:!0,constant:!1,selective:!1,insertion_order:100,position:"after_char",use_regex:!1,extensions:{position:4,probability:100,depth:4,case_sensitive:!1,match_whole_words:!1,prevent_recursion:!1}}),U.value.add(u)},N=u=>{const l=t.value.worldBookEntries.findIndex(g=>g.id===u);l>-1&&t.value.worldBookEntries.splice(l,1)},_=(u,l,g)=>{const c=t.value.worldBookEntries.find(w=>w.id===u);c&&(c[l]=g)},q=(u,l,g)=>{const c=t.value.worldBookEntries.find(w=>w.id===u);c&&(c.extensions||(c.extensions={}),c.extensions[l]=g)},L=Y(()=>{if(!t.value.worldBookSearch)return t.value.worldBookEntries;const u=t.value.worldBookSearch.toLowerCase();return t.value.worldBookEntries.filter(l=>{const g=(l.comment||"").toLowerCase(),c=(l.keys||[]).join(",").toLowerCase(),w=(l.content||"").toLowerCase();return g.includes(u)||c.includes(u)||w.includes(u)})}),T=A(null),G=async u=>{const l=u.target.files?.[0];if(l){try{const g=await l.text(),c=JSON.parse(g);let w=[];if(Array.isArray(c))w=c;else if(c.entries&&Array.isArray(c.entries))w=c.entries,c.name&&(t.value.worldBookName=c.name);else{R.add({title:"无效的JSON格式",color:"error"});return}const M=[];for(let j=0;j<w.length;j++){const n=w[j];if(!n||typeof n!="object")continue;const D=typeof n.content=="string"&&n.content.trim()!=="",d=Array.isArray(n.keys)&&n.keys.length>0;!D&&!d||M.push({id:n.id??Date.now()+j,keys:Array.isArray(n.keys)?n.keys:[],secondary_keys:Array.isArray(n.secondary_keys)?n.secondary_keys:[],comment:String(n.comment||""),content:String(n.content||""),enabled:n.enabled!==!1,constant:!!n.constant,selective:n.selective!==!1,insertion_order:Number(n.insertion_order)||0,position:String(n.position||"after_char"),use_regex:!!n.use_regex,extensions:n.extensions||{position:4,probability:100,depth:4}})}M.length>0?(t.value.worldBookEntries=M,R.add({title:`成功导入 ${M.length} 个条目`,color:"success"})):R.add({title:"未找到有效的世界书条目",color:"error"})}catch{R.add({title:"文件解析失败",color:"error"})}u.target.value=""}},S=[{label:"角色定义之前",value:"before_char|0|0"},{label:"角色定义之后",value:"after_char|1|0"},{label:"作者注释之前",value:"after_char|2|0"},{label:"作者注释之后",value:"after_char|3|0"},{label:"智能插入",value:"after_char|4|0"},{label:"智能插入-User",value:"after_char|4|1"},{label:"智能插入-AI",value:"after_char|4|2"},{label:"智能插入-System",value:"after_char|4|3"}],x=[{label:"始终触发",value:"always"},{label:"关键词触发",value:"keyword"}],B=u=>{const l=u.position||"after_char",g=u.extensions?.position??4,c=u.extensions?.role??0;return`${l}|${g}|${c}`},E=(u,l)=>{const g=l.split("|");u.position=g[0],u.extensions||(u.extensions={}),u.extensions.position=parseInt(g[1]),u.extensions.role=parseInt(g[2])};return(u,l)=>{const g=ce,c=be,w=me,M=fe,j=ke,n=we,D=xe;return m(),y("div",Xs,[l[26]||(l[26]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-gray-100"}," 角色专属世界书 ",-1)),e("div",Zs,[e("div",ea,[o(g,{name:"i-lucide-globe",class:"w-5 h-5"}),l[4]||(l[4]=e("span",{class:"font-medium"},"世界书管理",-1))]),e("div",ta,[o(c,{modelValue:s(t).worldBookSearch,"onUpdate:modelValue":l[0]||(l[0]=d=>s(t).worldBookSearch=d),placeholder:"搜索条目...",class:"flex-1 max-w-md"},{leading:v(()=>[o(g,{name:"i-lucide-search",class:"w-4 h-4 text-gray-400"})]),_:1},8,["modelValue"]),o(w,{variant:"outline",onClick:l[1]||(l[1]=d=>s(T)?.click())},{leading:v(()=>[o(g,{name:"i-lucide-upload",class:"w-4 h-4"})]),default:v(()=>[l[5]||(l[5]=V(" 导入 ",-1))]),_:1}),o(w,{onClick:r},{leading:v(()=>[o(g,{name:"i-lucide-plus",class:"w-4 h-4"})]),default:v(()=>[l[6]||(l[6]=V(" 添加条目 ",-1))]),_:1})]),e("input",{ref_key:"fileInputRef",ref:T,type:"file",accept:".json",class:"hidden",onChange:G},null,544),e("div",null,[l[7]||(l[7]=e("label",{class:"block text-sm text-gray-500 mb-2"},"世界书名称",-1)),o(c,{modelValue:s(t).worldBookName,"onUpdate:modelValue":l[2]||(l[2]=d=>s(t).worldBookName=d),placeholder:"给世界书起个名字...",class:"w-full"},null,8,["modelValue"])])]),e("div",sa,[s(L).length===0?(m(),y("div",aa,[o(g,{name:"i-lucide-globe",class:"w-12 h-12 mx-auto mb-4 opacity-50"}),l[8]||(l[8]=e("p",null,"暂无世界书条目，点击上方添加",-1))])):C("",!0),(m(!0),y(ee,null,de(s(L),d=>(m(),y("div",{key:d.id,class:"bg-gray-50 dark:bg-gray-800/50 rounded-xl overflow-hidden"},[e("div",{class:"flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",onClick:a=>F(d.id)},[o(M,{"model-value":d.enabled,size:"sm",onClick:l[3]||(l[3]=ve(()=>{},["stop"])),"onUpdate:modelValue":a=>_(d.id,"enabled",a)},null,8,["model-value","onUpdate:modelValue"]),o(g,{name:s(U).has(d.id)?"i-lucide-chevron-down":"i-lucide-chevron-right",class:"w-4 h-4 text-gray-400"},null,8,["name"]),e("span",ra,h(d.comment||"未命名条目"),1),o(j,{color:d.constant?"primary":"neutral",variant:"soft",size:"xs"},{default:v(()=>[V(h(d.constant?"始终":"选择性"),1)]),_:2},1032,["color"]),o(w,{variant:"ghost",size:"xs",color:"error",onClick:ve(a=>N(d.id),["stop"])},{default:v(()=>[o(g,{name:"i-lucide-trash-2",class:"w-4 h-4"})]),_:1},8,["onClick"])],8,la),s(U).has(d.id)?(m(),y("div",oa,[e("div",null,[l[9]||(l[9]=e("label",{class:"block text-sm text-gray-500 mb-2"},"标题",-1)),o(c,{"model-value":d.comment,placeholder:"条目标题",class:"w-full","onUpdate:modelValue":a=>_(d.id,"comment",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[10]||(l[10]=e("label",{class:"block text-sm text-gray-500 mb-2"},"主要关键词",-1)),o(c,{"model-value":(d.keys||[]).join(", "),placeholder:"输入关键词，用逗号分隔",class:"w-full","onUpdate:modelValue":a=>_(d.id,"keys",(a||"").split(",").map(b=>b.trim()).filter(Boolean))},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[11]||(l[11]=e("label",{class:"block text-sm text-gray-500 mb-2"},"次要关键词",-1)),o(c,{"model-value":(d.secondary_keys||[]).join(", "),placeholder:"输入次要关键词，用逗号分隔",class:"w-full","onUpdate:modelValue":a=>_(d.id,"secondary_keys",(a||"").split(",").map(b=>b.trim()).filter(Boolean))},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[12]||(l[12]=e("label",{class:"block text-sm text-gray-500 mb-2"},"触发模式",-1)),o(n,{"model-value":d.constant?"always":"keyword",items:x,"value-key":"value",class:"w-full","onUpdate:modelValue":a=>_(d.id,"constant",a==="always")},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[13]||(l[13]=e("label",{class:"block text-sm text-gray-500 mb-2"},"插入位置",-1)),o(n,{"model-value":B(d),items:S,"value-key":"value",class:"w-full","onUpdate:modelValue":a=>E(d,a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[14]||(l[14]=e("label",{class:"block text-sm text-gray-500 mb-2"},"内容",-1)),o(D,{"model-value":d.content,placeholder:"输入世界书内容...",rows:6,class:"w-full font-mono text-sm","onUpdate:modelValue":a=>_(d.id,"content",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",na,[e("div",null,[l[15]||(l[15]=e("label",{class:"block text-sm text-gray-500 mb-2"},"优先级",-1)),o(c,{type:"number","model-value":d.insertion_order,class:"w-full","onUpdate:modelValue":a=>_(d.id,"insertion_order",Number(a))},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[16]||(l[16]=e("label",{class:"block text-sm text-gray-500 mb-2"},"触发概率 (%)",-1)),o(c,{type:"number","model-value":d.extensions?.probability??100,min:"0",max:"100",class:"w-full","onUpdate:modelValue":a=>q(d.id,"probability",Number(a))},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[l[17]||(l[17]=e("label",{class:"block text-sm text-gray-500 mb-2"},"扫描深度",-1)),o(c,{type:"number","model-value":d.extensions?.depth||0,min:"0",class:"w-full","onUpdate:modelValue":a=>q(d.id,"depth",Number(a))},null,8,["model-value","onUpdate:modelValue"])])]),e("div",ia,[l[25]||(l[25]=e("h4",{class:"font-medium text-gray-700 dark:text-gray-300 mb-3"}," 高级设置 ",-1)),e("div",da,[e("div",ua,[l[18]||(l[18]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"启用"),e("p",{class:"text-xs text-gray-400"}," 是否让该条目生效 ")],-1)),o(M,{"model-value":d.enabled,size:"sm","onUpdate:modelValue":a=>_(d.id,"enabled",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",ca,[l[19]||(l[19]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"大小写敏感"),e("p",{class:"text-xs text-gray-400"}," 匹配时区分大小写 ")],-1)),o(M,{"model-value":d.extensions?.case_sensitive||!1,size:"sm","onUpdate:modelValue":a=>q(d.id,"case_sensitive",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",ma,[l[20]||(l[20]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"正则匹配"),e("p",{class:"text-xs text-gray-400"}," keys 用正则匹配 ")],-1)),o(M,{"model-value":d.use_regex,size:"sm","onUpdate:modelValue":a=>_(d.id,"use_regex",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",ga,[l[21]||(l[21]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"全词匹配"),e("p",{class:"text-xs text-gray-400"}," 类似精确匹配 ")],-1)),o(M,{"model-value":d.extensions?.match_whole_words||!1,size:"sm","onUpdate:modelValue":a=>q(d.id,"match_whole_words",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",pa,[l[22]||(l[22]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"选择性注入"),e("p",{class:"text-xs text-gray-400"}," 按系统规则选择插入 ")],-1)),o(M,{"model-value":d.selective,size:"sm","onUpdate:modelValue":a=>_(d.id,"selective",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",xa,[l[23]||(l[23]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"恒定注入"),e("p",{class:"text-xs text-gray-400"}," 始终插入（按系统定义） ")],-1)),o(M,{"model-value":d.constant,size:"sm","onUpdate:modelValue":a=>_(d.id,"constant",a)},null,8,["model-value","onUpdate:modelValue"])]),e("div",ya,[l[24]||(l[24]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"阻止递归"),e("p",{class:"text-xs text-gray-400"}," 防止AI跟自己对话 ")],-1)),o(M,{"model-value":d.extensions?.prevent_recursion||!1,size:"sm","onUpdate:modelValue":a=>q(d.id,"prevent_recursion",a)},null,8,["model-value","onUpdate:modelValue"])])])])])):C("",!0)]))),128))])])}}}),fa=Object.assign(va,{__name:"AmusementDetailWorldbook"}),ba={class:"p-6 space-y-6"},ka={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},wa={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-4"},ha={class:"flex items-center gap-3"},_a={class:"space-y-3"},$a={key:0,class:"p-16 text-center text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl"},Va=["onClick"],Ua={class:"font-medium text-gray-900 dark:text-gray-100 flex-1"},Ia={key:0,class:"p-4 border-t border-gray-100 dark:border-gray-800 space-y-4"},Ca={class:"grid grid-cols-2 gap-4"},Sa={class:"pt-4 border-t border-gray-100 dark:border-gray-800"},ja={class:"space-y-2"},Na={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},za={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Ra={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Ea={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Aa={class:"pt-4 border-t border-gray-100 dark:border-gray-800"},Ba={class:"space-y-2"},Da={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Oa={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Ta={class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"},Pa=ge({__name:"Regex",props:{state:{}},emits:["update:state"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:S=>P("update:state",S)}),U=A(new Set),F=S=>{U.value.has(S)?U.value.delete(S):U.value.add(S)},r=()=>{const S=String(Date.now());t.value.regexEntries.push({id:S,scriptName:"",findRegex:"",replaceString:"",placement:[],disabled:!1,markdownOnly:!1,promptOnly:!1,trimStrings:[]}),U.value.add(S)},N=S=>{const x=t.value.regexEntries.findIndex(B=>B.id===S);x>-1&&t.value.regexEntries.splice(x,1)},_=(S,x,B)=>{const E=t.value.regexEntries.find(u=>u.id===S);E&&(E[x]=B)},q=(S,x,B)=>{const E=t.value.regexEntries.find(u=>u.id===S);E&&(Array.isArray(E.placement)||(E.placement=[]),B?E.placement.includes(x)||E.placement.push(x):E.placement=E.placement.filter(u=>u!==x))},L=Y(()=>{if(!t.value.regexSearch)return t.value.regexEntries;const S=t.value.regexSearch.toLowerCase();return t.value.regexEntries.filter(x=>(x.scriptName||"").toLowerCase().includes(S)||(x.findRegex||"").toLowerCase().includes(S))}),T=A(null),G=async S=>{const x=S.target.files?.[0];if(x){try{const B=await x.text(),E=JSON.parse(B);let u=[];if(Array.isArray(E))u=E;else{R.add({title:"无效的JSON格式",color:"error"});return}const l=u.map((g,c)=>({id:g.id||String(Date.now()+c),scriptName:g.scriptName||"",findRegex:g.findRegex||"",replaceString:g.replaceString||"",placement:Array.isArray(g.placement)?g.placement:[],disabled:!!g.disabled,markdownOnly:!!g.markdownOnly,promptOnly:!!g.promptOnly,trimStrings:Array.isArray(g.trimStrings)?g.trimStrings:[]}));l.length>0&&(t.value.regexEntries=l,R.add({title:`成功导入 ${l.length} 个正则`,color:"success"}))}catch{R.add({title:"文件解析失败",color:"error"})}S.target.value=""}};return(S,x)=>{const B=ce,E=be,u=me,l=fe,g=xe;return m(),y("div",ba,[x[20]||(x[20]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-gray-100"}," 正则脚本 ",-1)),e("div",ka,[e("div",wa,[o(B,{name:"i-lucide-regex",class:"w-5 h-5"}),x[3]||(x[3]=e("span",{class:"font-medium"},"正则管理",-1))]),e("div",ha,[o(E,{modelValue:s(t).regexSearch,"onUpdate:modelValue":x[0]||(x[0]=c=>s(t).regexSearch=c),placeholder:"搜索正则...",class:"flex-1 max-w-md"},{leading:v(()=>[o(B,{name:"i-lucide-search",class:"w-4 h-4 text-gray-400"})]),_:1},8,["modelValue"]),o(u,{variant:"outline",onClick:x[1]||(x[1]=c=>s(T)?.click())},{leading:v(()=>[o(B,{name:"i-lucide-upload",class:"w-4 h-4"})]),default:v(()=>[x[4]||(x[4]=V(" 导入 ",-1))]),_:1}),o(u,{onClick:r},{leading:v(()=>[o(B,{name:"i-lucide-plus",class:"w-4 h-4"})]),default:v(()=>[x[5]||(x[5]=V(" 添加正则 ",-1))]),_:1})])]),e("input",{ref_key:"fileInputRef",ref:T,type:"file",accept:".json",class:"hidden",onChange:G},null,544),e("div",_a,[s(L).length===0?(m(),y("div",$a,[o(B,{name:"i-lucide-regex",class:"w-12 h-12 mx-auto mb-4 opacity-50"}),x[6]||(x[6]=e("p",null,"暂无正则脚本，点击上方添加",-1))])):C("",!0),(m(!0),y(ee,null,de(s(L),c=>(m(),y("div",{key:c.id,class:"bg-gray-50 dark:bg-gray-800/50 rounded-xl overflow-hidden"},[e("div",{class:"flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",onClick:w=>F(c.id)},[o(B,{name:"i-lucide-grip-vertical",class:"w-5 h-5 text-gray-400"}),o(l,{"model-value":!c.disabled,size:"sm",onClick:x[2]||(x[2]=ve(()=>{},["stop"])),"onUpdate:modelValue":w=>_(c.id,"disabled",!w)},null,8,["model-value","onUpdate:modelValue"]),o(B,{name:s(U).has(c.id)?"i-lucide-chevron-down":"i-lucide-chevron-right",class:"w-4 h-4 text-gray-400"},null,8,["name"]),e("span",Ua,h(c.scriptName||"未命名规则"),1),o(u,{variant:"ghost",size:"xs",color:"error",onClick:ve(w=>N(c.id),["stop"])},{default:v(()=>[o(B,{name:"i-lucide-trash-2",class:"w-4 h-4"})]),_:1},8,["onClick"])],8,Va),s(U).has(c.id)?(m(),y("div",Ia,[e("div",Ca,[e("div",null,[x[7]||(x[7]=e("label",{class:"block text-sm text-gray-500 mb-2"},"规则ID",-1)),o(E,{"model-value":c.id,disabled:"",class:"w-full bg-gray-100 dark:bg-gray-900"},null,8,["model-value"])]),e("div",null,[x[8]||(x[8]=e("label",{class:"block text-sm text-gray-500 mb-2"},"脚本名称",-1)),o(E,{"model-value":c.scriptName,placeholder:"Script Name",class:"w-full","onUpdate:modelValue":w=>_(c.id,"scriptName",w)},null,8,["model-value","onUpdate:modelValue"])])]),e("div",null,[x[9]||(x[9]=e("label",{class:"block text-sm text-gray-500 mb-2"},"查找正则 *",-1)),o(E,{"model-value":c.findRegex,placeholder:"\\*([\\\\s\\\\S]*?)\\*",class:"w-full font-mono","onUpdate:modelValue":w=>_(c.id,"findRegex",w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",null,[x[10]||(x[10]=e("label",{class:"block text-sm text-gray-500 mb-2"},"替换内容 *",-1)),o(g,{"model-value":c.replaceString,placeholder:'<span class="highlight">$1</span>',rows:4,class:"w-full font-mono","onUpdate:modelValue":w=>_(c.id,"replaceString",w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",Sa,[x[15]||(x[15]=e("h4",{class:"font-medium text-gray-700 dark:text-gray-300 mb-3"}," 作用范围 ",-1)),e("div",ja,[e("div",Na,[x[11]||(x[11]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"用户输入"),e("p",{class:"text-xs text-gray-400"}," 应用于用户输入内容 ")],-1)),o(l,{"model-value":(c.placement||[]).includes(1),size:"sm","onUpdate:modelValue":w=>q(c.id,1,w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",za,[x[12]||(x[12]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"AI输出"),e("p",{class:"text-xs text-gray-400"}," 应用于AI输出内容 ")],-1)),o(l,{"model-value":(c.placement||[]).includes(2),size:"sm","onUpdate:modelValue":w=>q(c.id,2,w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",Ra,[x[13]||(x[13]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"快捷命令"),e("p",{class:"text-xs text-gray-400"}," 应用于快捷命令 ")],-1)),o(l,{"model-value":(c.placement||[]).includes(3),size:"sm","onUpdate:modelValue":w=>q(c.id,3,w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",Ea,[x[14]||(x[14]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"世界信息"),e("p",{class:"text-xs text-gray-400"}," 应用于世界书内容 ")],-1)),o(l,{"model-value":(c.placement||[]).includes(4),size:"sm","onUpdate:modelValue":w=>q(c.id,4,w)},null,8,["model-value","onUpdate:modelValue"])])])]),e("div",Aa,[x[19]||(x[19]=e("h4",{class:"font-medium text-gray-700 dark:text-gray-300 mb-3"}," 其他选项 ",-1)),e("div",Ba,[e("div",Da,[x[16]||(x[16]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"是否启用"),e("p",{class:"text-xs text-gray-400"}," 启用或禁用此正则规则 ")],-1)),o(l,{"model-value":!c.disabled,size:"sm","onUpdate:modelValue":w=>_(c.id,"disabled",!w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",Oa,[x[17]||(x[17]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"仅改变显示"),e("p",{class:"text-xs text-gray-400"}," 仅影响显示，不影响发送内容 ")],-1)),o(l,{"model-value":c.markdownOnly||!1,size:"sm","onUpdate:modelValue":w=>_(c.id,"markdownOnly",w)},null,8,["model-value","onUpdate:modelValue"])]),e("div",Ta,[x[18]||(x[18]=e("div",null,[e("span",{class:"text-sm text-gray-700 dark:text-gray-300"},"仅改变发送"),e("p",{class:"text-xs text-gray-400"}," 仅影响发送内容，不影响显示 ")],-1)),o(l,{"model-value":c.promptOnly||!1,size:"sm","onUpdate:modelValue":w=>_(c.id,"promptOnly",w)},null,8,["model-value","onUpdate:modelValue"])])])])])):C("",!0)]))),128))])])}}}),Ga=Object.assign(Pa,{__name:"AmusementDetailRegex"}),La={class:"p-6 space-y-6"},Ma={class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Ja={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-2"},qa={class:"space-y-3"},Fa={class:"flex items-center justify-between mb-3"},Ha={class:"font-medium text-gray-900 dark:text-gray-100"},Wa={class:"text-right text-xs text-gray-400 mt-2"},Qa=ge({__name:"Quickreply",props:{state:{}},emits:["update:state"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:r=>P("update:state",r)}),U=()=>{if(t.value.quickReplies.length>=5){R.add({title:"最多只能添加5条开场白",color:"error"});return}t.value.quickReplies.push({id:String(Date.now()),content:""})},F=r=>{if(t.value.quickReplies.length<=1)return;const N=t.value.quickReplies.findIndex(_=>_.id===r);N>-1&&t.value.quickReplies.splice(N,1)};return(r,N)=>{const _=ce,q=me,L=xe;return m(),y("div",La,[N[4]||(N[4]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-gray-100"}," 开场白 ",-1)),e("div",Ma,[e("div",Ja,[o(_,{name:"i-lucide-message-square",class:"w-5 h-5"}),N[0]||(N[0]=e("span",{class:"font-medium"},"开场白管理",-1))]),N[1]||(N[1]=e("p",{class:"text-sm text-gray-500"}," 设置角色的开场白内容，最多可添加5条 ",-1))]),e("div",qa,[(m(!0),y(ee,null,de(s(t).quickReplies,(T,G)=>(m(),y("div",{key:T.id,class:"p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},[e("div",Fa,[e("span",Ha,"开场白 "+h(G+1),1),o(q,{variant:"ghost",size:"xs",color:"error",disabled:s(t).quickReplies.length<=1,onClick:S=>F(T.id)},{default:v(()=>[o(_,{name:"i-lucide-trash-2",class:"w-4 h-4 mr-1"}),N[2]||(N[2]=V(" 删除 ",-1))]),_:1},8,["disabled","onClick"])]),o(L,{modelValue:T.content,"onUpdate:modelValue":S=>T.content=S,placeholder:"请输入角色的开场白内容...",rows:5,class:"w-full"},null,8,["modelValue","onUpdate:modelValue"]),e("div",Wa,h((T.content||"").length)+"/10000 ",1)]))),128))]),e("button",{class:"w-full py-3 text-sm font-medium rounded-lg bg-gray-900 text-white hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-gray-200 transition-colors flex items-center justify-center gap-2",onClick:U},[o(_,{name:"i-lucide-plus",class:"w-4 h-4"}),N[3]||(N[3]=V(" 新增开场白 ",-1))]),N[5]||(N[5]=e("p",{class:"text-sm text-gray-500"}," 建议填写 1-3 条，最多 5 条 ",-1))])}}}),Ka=Object.assign(Qa,{__name:"AmusementDetailQuickreply"}),Ya={class:"p-6 space-y-6"},Xa={class:"flex items-center justify-between"},Za={key:0,class:"grid grid-cols-2 gap-4"},el={class:"p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl"},tl={class:"flex items-center gap-2 mb-2"},sl={key:0,class:"text-sm text-green-600 dark:text-green-400"},al={key:1,class:"text-sm text-gray-500"},ll={class:"p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl"},rl={class:"flex items-center gap-2 mb-2"},ol={key:0,class:"text-sm text-yellow-600 dark:text-yellow-400"},nl={key:1,class:"text-sm text-gray-500"},il={class:"flex items-center gap-2 text-gray-700 dark:text-gray-300"},dl={key:1,class:"p-16 text-center text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl"},ul={key:2,class:"space-y-3"},cl={class:"flex items-center justify-between"},ml={class:"flex items-center gap-3"},gl={class:"font-medium text-lg"},pl={class:"flex items-center gap-2"},xl={class:"text-sm text-gray-500"},yl={key:0,class:"mt-2 text-sm text-gray-600 dark:text-gray-400"},vl={class:"flex items-center gap-2"},fl={class:"p-5 space-y-5"},bl={class:"grid grid-cols-2 gap-4"},kl={key:0},wl={class:"flex justify-end gap-2"},hl={class:"flex items-center gap-3"},_l={class:"p-4 space-y-4"},$l={class:"grid grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"},Vl={key:0,class:"mt-2 text-xs text-gray-500"},Ul={key:0,class:"mt-2 text-xs text-gray-500"},Il={class:"flex items-center justify-between"},Cl={class:"flex items-center gap-2"},Sl={key:0,class:"flex items-center gap-2 text-sm text-gray-500"},jl={key:0,class:"max-h-[60vh] overflow-y-auto space-y-4"},Nl={key:0,class:"py-12 text-center"},zl={class:"px-4 py-3 bg-gray-100 dark:bg-gray-800 flex items-center gap-2"},Rl={class:"font-medium text-gray-700 dark:text-gray-300"},El={class:"divide-y divide-gray-200 dark:divide-gray-700"},Al={class:"flex items-center gap-2 mb-2"},Bl={class:"text-sm font-medium text-gray-700 dark:text-gray-300"},Dl={class:"grid grid-cols-2 gap-3"},Ol={class:"min-h-[60px]"},Tl=["src"],Pl={class:"min-h-[60px]"},Gl=["src"],Ll={class:"flex justify-end"},Ml=ge({__name:"Version",props:{state:{}},emits:["update:state","publish","switch-version"],setup(ne,{emit:le}){const se=ne,P=le,R=ue(),t=Y({get:()=>se.state,set:p=>P("update:state",p)}),U=A(!1),F=A(!1),r=A(null),N=A(null),_=A(null),q=A(null),L=A([]),T=A([]),G=A("all"),S=Y(()=>t.value.versions.map(p=>({label:`v${p.version} - ${w(p.state)}`,value:p.id}))),x=Y(()=>t.value.versions.find(p=>p.state===1)),B=Y(()=>{const p=t.value.reviewVersionId;return t.value.versions.find(i=>i.id===p)}),E=A(!1),u=A(null),l=A(2),g=A(""),c=p=>{if(!p)return"";const i=new Date(p);return`${i.getFullYear()}/${String(i.getMonth()+1).padStart(2,"0")}/${String(i.getDate()).padStart(2,"0")} ${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}`},w=p=>{switch(p){case 0:return"草稿";case 1:return"待审核";case 2:return"已发布";case 3:return"已拒绝";case 4:return"已删除";default:return"未知"}},M=p=>{switch(p){case 0:return"neutral";case 1:return"warning";case 2:return"success";case 3:return"error";case 4:return"neutral";default:return"neutral"}},j=p=>p.state===1||p.state===2,n=p=>{u.value=p,l.value=2,g.value="",E.value=!0},D=()=>{if(l.value===3&&!g.value.trim()){R.add({title:"请输入拒绝理由",color:"error"});return}l.value===2?P("publish",u.value,{seeking:2}):P("publish",u.value,{seeking:3,reason:g.value}),E.value=!1},d=[{name:"基础信息",icon:"i-lucide-user",fields:[{key:"data.name",label:"角色名称"},{key:"data.creator",label:"创作者"},{key:"data.tags",label:"标签"},{key:"anohana.summary",label:"简介"}]},{name:"角色设定",icon:"i-lucide-file-text",fields:[{key:"data.description",label:"描述"},{key:"data.personality",label:"性格"},{key:"data.scenario",label:"场景"},{key:"data.system_prompt",label:"系统提示词"},{key:"data.creator_notes",label:"创作者备注"}]},{name:"对话内容",icon:"i-lucide-message-square",fields:[{key:"data.first_mes",label:"开场白"},{key:"data.alternate_greetings",label:"备选开场白"},{key:"data.mes_example",label:"对话示例"},{key:"anohana.guide",label:"快速回复"}]},{name:"扩展数据",icon:"i-lucide-puzzle",fields:[{key:"data.character_book",label:"世界书"},{key:"data.regex",label:"正则规则"}]},{name:"媒体资源",icon:"i-lucide-image",fields:[{key:"anohana.image",label:"背景图"},{key:"anohana.avatar",label:"头像"}]},{name:"发布设置",icon:"i-lucide-settings",fields:[{key:"anohana.source",label:"是否转载"},{key:"anohana.source_url",label:"原作链接"},{key:"anohana.anonymous",label:"匿名发布"},{key:"anohana.nsfw",label:"NSFW"}]}],a=(p,i)=>{if(!(!p||!i))return i.split(".").reduce((O,z)=>O?.[z],p)},b=(p,i=!1)=>p==null||p===""?"(空)":p===!0?"是":p===!1?"否":i&&typeof p=="string"&&p.startsWith("http")?p:Array.isArray(p)?p.length===0?"(空)":typeof p[0]=="string"?p.join(`
`):JSON.stringify(p,null,2):typeof p=="object"?JSON.stringify(p,null,2):String(p),k=(p,i)=>p===i||p==null&&i==null?!0:p==null||i==null?!1:JSON.stringify(p)===JSON.stringify(i),H=p=>p.includes("image")||p.includes("avatar"),re=()=>{if(t.value.versions.length<2){R.add({title:"至少需要2个版本才能对比",color:"warning"});return}B.value?r.value=B.value.id:r.value=t.value.versions[1]?.id||null,x.value?N.value=x.value.id:N.value=t.value.versions[0]?.id||null,U.value=!0,G.value="all",f()},f=async()=>{if(!(!r.value||!N.value)&&t.value.amusementId){F.value=!0,L.value=[],T.value=[];try{const[p,i]=await Promise.all([ye({id:t.value.amusementId,version_id:r.value}),ye({id:t.value.amusementId,version_id:N.value})]);if(p.error||!p.data?.body){R.add({title:"获取左侧版本失败",color:"error"});return}if(i.error||!i.data?.body){R.add({title:"获取右侧版本失败",color:"error"});return}_.value=JSON.parse(p.data.body),q.value=JSON.parse(i.data.body),$()}catch(p){R.add({title:p.message||"对比失败",color:"error"})}finally{F.value=!1}}},$=()=>{const p=[],i=[];for(const O of d){const z={name:O.name,icon:O.icon,fields:[]};for(const K of O.fields){const ae=a(_.value,K.key),X=a(q.value,K.key),ie=k(ae,X),I=H(K.key),Z={key:K.key,label:K.label,leftVal:ae,rightVal:X,isSame:ie,isImage:I};z.fields.push(Z),ie||i.push({...Z,group:O.name})}p.push(z)}L.value=p,T.value=i};Be([r,N],()=>{U.value&&r.value&&N.value&&f()});const W=Y(()=>G.value==="diff"?L.value.map(p=>({...p,fields:p.fields.filter(i=>!i.isSame)})).filter(p=>p.fields.length>0):L.value),Q=p=>p?t.value.versions.find(i=>i.id===p):null;return(p,i)=>{const O=ce,z=me,K=ke,ae=xe,X=$e,ie=we;return m(),y(ee,null,[e("div",Ya,[e("div",Xa,[i[12]||(i[12]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-gray-100"}," 版本管理 ",-1)),s(t).versions.length>=2?(m(),J(z,{key:0,variant:"soft",color:"primary",onClick:re},{leading:v(()=>[o(O,{name:"i-lucide-git-compare",class:"w-4 h-4"})]),default:v(()=>[i[11]||(i[11]=V(" 版本对比 ",-1))]),_:1})):C("",!0)]),s(B)||s(x)?(m(),y("div",Za,[e("div",el,[e("div",tl,[o(O,{name:"i-lucide-check-circle",class:"w-5 h-5 text-green-500"}),i[13]||(i[13]=e("span",{class:"font-medium text-green-700 dark:text-green-300"},"当前使用版本",-1))]),s(B)?(m(),y("div",sl,[e("p",null,"版本号: v"+h(s(B).version),1),e("p",null,"发布时间: "+h(c(s(B).created_at)),1)])):(m(),y("div",al," 暂无发布版本 "))]),e("div",ll,[e("div",rl,[o(O,{name:"i-lucide-clock",class:"w-5 h-5 text-yellow-500"}),i[14]||(i[14]=e("span",{class:"font-medium text-yellow-700 dark:text-yellow-300"},"待审核版本",-1))]),s(x)?(m(),y("div",ol,[e("p",null,"版本号: v"+h(s(x).version),1),e("p",null,"提交时间: "+h(c(s(x).created_at)),1)])):(m(),y("div",nl," 暂无待审核版本 "))])])):C("",!0),e("div",il,[o(O,{name:"i-lucide-git-branch",class:"w-5 h-5"}),i[15]||(i[15]=e("span",{class:"font-medium"},"全部版本",-1)),o(K,{color:"neutral",variant:"soft",size:"xs"},{default:v(()=>[V(h(s(t).versions.length),1)]),_:1})]),s(t).versions.length===0?(m(),y("div",dl,[o(O,{name:"i-lucide-git-branch",class:"w-12 h-12 mx-auto mb-4 opacity-50"}),i[16]||(i[16]=e("p",null,"暂无版本记录",-1))])):(m(),y("div",ul,[(m(!0),y(ee,null,de(s(t).versions,I=>(m(),y("div",{key:I.id,class:oe(["p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl transition-all",{"ring-2 ring-primary-500":I.id===s(t).editingVersionId,"ring-2 ring-green-500":I.id===s(t).reviewVersionId&&I.id!==s(t).editingVersionId,"ring-2 ring-yellow-500":I.state===1&&I.id!==s(t).editingVersionId}])},[e("div",cl,[e("div",ml,[e("span",gl,"v"+h(I.version),1),o(K,{color:M(I.state),variant:"soft",size:"xs"},{default:v(()=>[V(h(w(I.state)),1)]),_:2},1032,["color"]),I.id===s(t).editingVersionId?(m(),J(K,{key:0,color:"primary",variant:"soft",size:"xs"},{default:v(()=>[...i[17]||(i[17]=[V(" 当前编辑 ",-1)])]),_:1})):C("",!0),I.id===s(t).reviewVersionId?(m(),J(K,{key:1,color:"success",variant:"soft",size:"xs"},{default:v(()=>[...i[18]||(i[18]=[V(" 使用中 ",-1)])]),_:1})):C("",!0)]),e("div",pl,[e("span",xl,h(c(I.created_at)),1),I.id!==s(t).editingVersionId?(m(),J(z,{key:0,size:"xs",variant:"ghost",onClick:Z=>P("switch-version",I.id)},{default:v(()=>[...i[19]||(i[19]=[V(" 切换 ",-1)])]),_:1},8,["onClick"])):C("",!0),j(I)?(m(),J(z,{key:1,size:"xs",variant:"outline",loading:s(t).publishing,onClick:Z=>n(I.id)},{default:v(()=>[...i[20]||(i[20]=[V(" 审核 ",-1)])]),_:1},8,["loading","onClick"])):C("",!0)])]),I.remarks?(m(),y("p",yl,h(I.remarks),1)):C("",!0)],2))),128))]))]),o(X,{open:s(E),"onUpdate:open":i[4]||(i[4]=I=>te(E)?E.value=I:null)},{header:v(()=>[e("div",vl,[o(O,{name:"i-lucide-shield-check",class:"w-5 h-5 text-primary-500"}),i[21]||(i[21]=e("span",{class:"font-semibold"},"版本审核",-1))])]),body:v(()=>[e("div",fl,[i[23]||(i[23]=e("p",{class:"text-sm text-gray-500"}," 请选择审核结果 ",-1)),e("div",bl,[e("button",{class:oe(["flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all",s(l)===2?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"]),onClick:i[0]||(i[0]=I=>l.value=2)},[o(O,{name:"i-lucide-check-circle",class:oe(["w-8 h-8",s(l)===2?"text-green-500":"text-gray-400"])},null,8,["class"]),e("span",{class:oe(["text-sm font-medium",s(l)===2?"text-green-600":"text-gray-600"])},"通过",2)],2),e("button",{class:oe(["flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all",s(l)===3?"border-red-500 bg-red-50 dark:bg-red-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"]),onClick:i[1]||(i[1]=I=>l.value=3)},[o(O,{name:"i-lucide-x-circle",class:oe(["w-8 h-8",s(l)===3?"text-red-500":"text-gray-400"])},null,8,["class"]),e("span",{class:oe(["text-sm font-medium",s(l)===3?"text-red-600":"text-gray-600"])},"拒绝",2)],2)]),s(l)===3?(m(),y("div",kl,[i[22]||(i[22]=e("label",{class:"block text-sm text-gray-500 mb-2"},"拒绝理由",-1)),o(ae,{modelValue:s(g),"onUpdate:modelValue":i[2]||(i[2]=I=>te(g)?g.value=I:null),placeholder:"请输入拒绝理由...",rows:3,class:"w-full"},null,8,["modelValue"])])):C("",!0)])]),footer:v(()=>[e("div",wl,[o(z,{variant:"outline",onClick:i[3]||(i[3]=I=>E.value=!1)},{default:v(()=>[...i[24]||(i[24]=[V(" 取消 ",-1)])]),_:1}),o(z,{loading:s(t).publishing,onClick:D},{default:v(()=>[...i[25]||(i[25]=[V(" 确认 ",-1)])]),_:1},8,["loading"])])]),_:1},8,["open"]),o(X,{open:s(U),"onUpdate:open":i[10]||(i[10]=I=>te(U)?U.value=I:null),ui:{width:"max-w-6xl"}},{header:v(()=>[e("div",hl,[o(O,{name:"i-lucide-git-compare",class:"w-5 h-5 text-primary-500"}),i[26]||(i[26]=e("span",{class:"font-semibold"},"版本对比",-1)),s(T).length>0?(m(),J(K,{key:0,color:"warning",variant:"soft",size:"xs"},{default:v(()=>[V(h(s(T).length)+" 处差异 ",1)]),_:1})):C("",!0)])]),body:v(()=>[e("div",_l,[e("div",$l,[e("div",null,[i[27]||(i[27]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"左侧版本（旧）",-1)),o(ie,{modelValue:s(r),"onUpdate:modelValue":i[5]||(i[5]=I=>te(r)?r.value=I:null),items:s(S),"value-key":"value",placeholder:"选择版本",class:"w-full"},null,8,["modelValue","items"]),Q(s(r))?(m(),y("div",Vl,h(c(Q(s(r))?.created_at)),1)):C("",!0)]),e("div",null,[i[28]||(i[28]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"右侧版本（新）",-1)),o(ie,{modelValue:s(N),"onUpdate:modelValue":i[6]||(i[6]=I=>te(N)?N.value=I:null),items:s(S),"value-key":"value",placeholder:"选择版本",class:"w-full"},null,8,["modelValue","items"]),Q(s(N))?(m(),y("div",Ul,h(c(Q(s(N))?.created_at)),1)):C("",!0)])]),e("div",Il,[e("div",Cl,[o(z,{size:"xs",variant:s(G)==="all"?"solid":"ghost",onClick:i[7]||(i[7]=I=>G.value="all")},{default:v(()=>[...i[29]||(i[29]=[V(" 全部字段 ",-1)])]),_:1},8,["variant"]),o(z,{size:"xs",variant:s(G)==="diff"?"solid":"ghost",onClick:i[8]||(i[8]=I=>G.value="diff")},{default:v(()=>[V(" 仅差异 ("+h(s(T).length)+") ",1)]),_:1},8,["variant"])]),s(F)?(m(),y("div",Sl,[o(O,{name:"i-lucide-loader-2",class:"w-4 h-4 animate-spin"}),i[30]||(i[30]=V(" 加载中... ",-1))])):C("",!0)]),s(F)?C("",!0):(m(),y("div",jl,[s(W).length===0&&s(G)==="diff"?(m(),y("div",Nl,[o(O,{name:"i-lucide-check-circle",class:"w-12 h-12 mx-auto mb-3 text-green-500"}),i[31]||(i[31]=e("p",{class:"text-gray-500"}," 两个版本内容完全相同 ",-1))])):C("",!0),(m(!0),y(ee,null,de(s(W),I=>(m(),y("div",{key:I.name,class:"border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden"},[e("div",zl,[o(O,{name:I.icon,class:"w-4 h-4 text-gray-500"},null,8,["name"]),e("span",Rl,h(I.name),1)]),e("div",El,[(m(!0),y(ee,null,de(I.fields,Z=>(m(),y("div",{key:Z.key,class:"p-3"},[e("div",Al,[e("span",Bl,h(Z.label),1),Z.isSame?(m(),J(K,{key:1,color:"success",variant:"soft",size:"xs"},{default:v(()=>[...i[33]||(i[33]=[V(" 相同 ",-1)])]),_:1})):(m(),J(K,{key:0,color:"warning",variant:"soft",size:"xs"},{default:v(()=>[...i[32]||(i[32]=[V(" 已修改 ",-1)])]),_:1}))]),e("div",Dl,[e("div",Ol,[i[34]||(i[34]=e("div",{class:"text-xs text-gray-400 mb-1"}," 左侧版本 ",-1)),Z.isImage&&Z.leftVal?(m(),y("img",{key:0,src:Z.leftVal,class:"w-20 h-20 object-cover rounded"},null,8,Tl)):(m(),y("pre",{key:1,class:oe(["text-sm whitespace-pre-wrap break-all p-2 rounded max-h-32 overflow-auto",Z.isSame?"bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400":"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400"])},h(b(Z.leftVal)),3))]),e("div",Pl,[i[35]||(i[35]=e("div",{class:"text-xs text-gray-400 mb-1"}," 右侧版本 ",-1)),Z.isImage&&Z.rightVal?(m(),y("img",{key:0,src:Z.rightVal,class:"w-20 h-20 object-cover rounded"},null,8,Gl)):(m(),y("pre",{key:1,class:oe(["text-sm whitespace-pre-wrap break-all p-2 rounded max-h-32 overflow-auto",Z.isSame?"bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400":"bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400"])},h(b(Z.rightVal)),3))])])]))),128))])]))),128))]))])]),footer:v(()=>[e("div",Ll,[o(z,{variant:"outline",onClick:i[9]||(i[9]=I=>U.value=!1)},{default:v(()=>[...i[36]||(i[36]=[V(" 关闭 ",-1)])]),_:1})])]),_:1},8,["open"])],64)}}}),Jl=Object.assign(Ml,{__name:"AmusementDetailVersion"}),ql={class:"flex h-[calc(100vh-4rem)]"},Fl={class:"w-44 shrink-0 border-r border-gray-200 dark:border-gray-800 flex flex-col"},Hl={class:"flex items-center justify-between px-4 py-3"},Wl={class:"flex-1 p-2 space-y-1"},Ql=["onClick"],Kl={class:"p-3 border-t border-gray-200 dark:border-gray-800 space-y-2"},Yl={class:"flex-1 overflow-auto"},Xl={key:0,class:"flex items-center justify-center py-20"},Vr=ge({name:"AmusementDetail",__name:"[id]",setup(ne){const le=Ve(),se=Ue(),P=ue(),R=Y(()=>le.params.id),t=Y(()=>R.value==="new"),U=A("overview"),F=[{key:"overview",label:"概览",icon:"i-lucide-file-text"},{key:"settings",label:"设定",icon:"i-lucide-settings-2"},{key:"worldbook",label:"世界书",icon:"i-lucide-globe"},{key:"regex",label:"正则",icon:"i-lucide-regex"},{key:"quickreply",label:"快速回复",icon:"i-lucide-message-square"},{key:"version",label:"版本管理",icon:"i-lucide-git-branch"}],r=De({loading:!1,saving:!1,publishing:!1,name:"",creatorName:"",summary:"",description:"",personality:"",scenario:"",mesExample:"",systemPrompt:"",creatorNotes:"",tags:[],greetings:[""],currentGreetingIndex:0,isPrivate:!1,isRepost:!1,isNsfw:!1,sourceUrl:"",backgroundImage:"",avatarImage:"",worldBookName:"",worldBookEntries:[],worldBookSearch:"",regexEntries:[],regexSearch:"",quickReplies:[{id:"1",content:""}],versions:[],amusementId:null,amusementState:0,amusementDraft:2,currentVersionId:null,reviewVersionId:null,editingVersionId:null,stats:{praiseCount:0,commentCount:0,collectCount:0,dialogueCount:0,playCount:0,score:0,scoreCount:0,battery:0},recommend:0,dayRecommend:0}),N=()=>{se.push("/amusement/list")},_=async(u=!0)=>{if(!t.value){r.loading=!0;try{const{data:l,error:g}=await Ce({biz_id:R.value});!g&&l&&await q(l,u)}catch(l){P.add({title:l.message||"加载失败",color:"error"})}finally{r.loading=!1}}},q=async(u,l=!0)=>{r.amusementId=u.id,r.amusementState=u.state??0,r.amusementDraft=u.draft??2,r.currentVersionId=u.version_id??null,r.reviewVersionId=u.review_version_id??null,r.versions=u.version||[];const g=u.item;if(g&&(r.stats.praiseCount=g.praise_count??0,r.stats.commentCount=g.comment_count??0,r.stats.collectCount=g.collect_count??0,r.stats.dialogueCount=g.dialogue_count??0,r.stats.playCount=g.play_count??0,r.stats.score=g.score??0,r.stats.scoreCount=g.score_count??0,r.stats.battery=g.battery??0,r.recommend=g.recommend??0,r.dayRecommend=g.day_recommend??0,r.isPrivate=g.anonymous===1,r.isNsfw=g.nsfw===1,r.isRepost=g.source===1,r.sourceUrl=g.source_url||""),r.versions.length>0&&l){const c=r.versions[0];r.editingVersionId=c.id;try{const{data:w}=await ye({id:r.amusementId,version_id:c.id});if(w?.body){const M=JSON.parse(w.body);L(M)}}catch{}}else if(l&&u.body)try{const c=JSON.parse(u.body);L(c)}catch{}},L=u=>{const l=u.data||u;r.name=l.name||u.name||"",r.creatorName=l.creator||"",r.summary=l.summary||"",r.description=l.description||"",r.personality=l.personality||"",r.scenario=l.scenario||"",r.mesExample=l.mes_example||"",r.systemPrompt=l.system_prompt||"",r.creatorNotes=l.creator_notes||"",r.tags=l.tags||[];const g=[l.first_mes||"",...l.alternate_greetings||[]].filter(Boolean);r.greetings=g.length>0?g:[""],r.currentGreetingIndex=0,l.character_book&&(r.worldBookEntries=l.character_book.entries||[],r.worldBookName=l.character_book.name||""),l.regex&&Array.isArray(l.regex)&&(r.regexEntries=l.regex.map((c,w)=>({...c,id:c.id!=null?String(c.id):String(w+1),placement:Array.isArray(c.placement)?c.placement:[],trimStrings:Array.isArray(c.trimStrings)?c.trimStrings:[]}))),u.anohana&&(u.anohana.image&&(r.backgroundImage=u.anohana.image),u.anohana.avatar&&(r.avatarImage=u.anohana.avatar),u.anohana.summary&&(r.summary=u.anohana.summary),r.isRepost=u.anohana.source===!0,r.sourceUrl=u.anohana.source_url||"",r.isPrivate=u.anohana.anonymous===!0,r.isNsfw=u.anohana.nsfw===!0,u.anohana.guide&&Array.isArray(u.anohana.guide)&&(r.quickReplies=u.anohana.guide))},T=()=>({spec:"chara_card_v2",spec_version:"2.0",name:r.name,anohana:{image:r.backgroundImage,avatar:r.avatarImage||r.backgroundImage,source:r.isRepost,source_url:r.sourceUrl,summary:r.summary,anonymous:r.isPrivate,nsfw:r.isNsfw,guide:r.quickReplies.filter(u=>(u.content||"").trim())},data:{name:r.name,description:r.description,personality:r.personality,scenario:r.scenario,mes_example:r.mesExample,first_mes:r.greetings[0]||"",alternate_greetings:r.greetings.slice(1),creator_notes:r.creatorNotes,system_prompt:r.systemPrompt,creator:r.creatorName,tags:r.tags,character_book:r.worldBookEntries.length>0?{name:r.worldBookName||`${r.name}的世界书`,entries:r.worldBookEntries}:void 0,regex:r.regexEntries.length>0?r.regexEntries:void 0}}),G=async()=>{if(!r.name.trim()){P.add({title:"请输入角色名称",color:"error"});return}r.saving=!0;try{const u=T();if(r.amusementId&&r.editingVersionId){const{error:l}=await Se({id:r.amusementId,version_id:r.editingVersionId,content:JSON.stringify(u)});l||(P.add({title:"保存成功",color:"success"}),await _(!1))}else{const{data:l,error:g}=await je({content:JSON.stringify(u),image:u.anohana?.image||"",source:u.anohana?.source||!1,source_url:u.anohana?.source_url||"",summary:u.anohana?.summary||"",avatar:u.anohana?.avatar||"",anonymous:r.isPrivate,nsfw:r.isNsfw,guide:JSON.stringify(r.quickReplies.filter(c=>(c.content||"").trim()))});!g&&l?.id&&(r.amusementId=l.id,P.add({title:"保存成功",color:"success"}),await _(!1),se.replace(`/amusement/detail/${l.id}`))}}catch(u){P.add({title:u.message||"保存失败",color:"error"})}finally{r.saving=!1}},S=async(u,l)=>{if(!r.amusementId){P.add({title:"请先保存",color:"error"});return}r.publishing=!0;try{const g={id:r.amusementId,version_id:u};l.seeking!==void 0&&(g.seeking=l.seeking),l.state!==void 0&&(g.state=l.state),l.reason&&(g.reason=l.reason);const{error:c}=await Ne(g);c||(P.add({title:l.seeking===2?"审核通过":"操作成功",color:"success"}),await _(!1))}catch(g){P.add({title:g.message||"操作失败",color:"error"})}finally{r.publishing=!1}},x=async u=>{const l=r.versions.find(g=>g.id===u);if(!(!l||!r.amusementId))try{const{data:g}=await ye({id:r.amusementId,version_id:u});if(g?.body){const c=JSON.parse(g.body);L(c),r.editingVersionId=u,P.add({title:`已切换到版本 ${l.version}`,color:"success"})}}catch(g){P.add({title:g.message||"切换版本失败",color:"error"})}},B=Y(()=>r.amusementId?r.amusementDraft===2?"草稿":r.amusementState===0?"待审核":r.amusementState===2?"已通过":"未通过":"未保存"),E=Y(()=>r.amusementId?r.amusementDraft===2?"text-yellow-500":r.amusementState===0?"text-blue-500":r.amusementState===2?"text-green-500":"text-red-500":"text-gray-400");return _e(()=>{_()}),(u,l)=>{const g=ce,c=we,w=me,M=ds,j=Ys,n=fa,D=Ga,d=Ka,a=Jl,b=Te;return m(),J(b,null,{default:v(()=>[e("div",ql,[e("div",Fl,[e("div",Hl,[e("button",{class:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100",onClick:N},[o(g,{name:"i-lucide-arrow-left",class:"w-4 h-4"}),l[7]||(l[7]=V(" 返回列表 ",-1))])]),e("nav",Wl,[(m(),y(ee,null,de(F,k=>e("button",{key:k.key,class:oe(["w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors",s(U)===k.key?"bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900":"text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800"]),onClick:H=>U.value=k.key},[o(g,{name:k.icon,class:"w-4 h-4"},null,8,["name"]),e("span",null,h(k.label),1)],10,Ql)),64))]),e("div",Kl,[s(r).versions.length>0?(m(),J(c,{key:0,"model-value":s(r).editingVersionId?.toString()||"",items:s(r).versions.map(k=>({label:`v${k.version}${k.id===s(r).reviewVersionId?" (使用中)":k.id===s(r).currentVersionId&&s(r).reviewVersionId!==s(r).currentVersionId?" (审核中)":k.state===2?" (已发布)":""}`,value:k.id.toString()})),"value-key":"value",size:"sm","onUpdate:modelValue":l[0]||(l[0]=k=>x(Number(k)))},null,8,["model-value","items"])):C("",!0),e("div",{class:oe(["text-xs",s(E)])},h(s(B)),3),o(w,{variant:"outline",size:"sm",class:"w-full",loading:s(r).saving,onClick:G},{leading:v(()=>[o(g,{name:"i-lucide-save",class:"w-3 h-3"})]),default:v(()=>[V(" "+h(s(r).amusementId?"保存":"新增保存"),1)]),_:1},8,["loading"])])]),e("div",Yl,[s(r).loading?(m(),y("div",Xl,[o(g,{name:"i-lucide-loader-2",class:"w-8 h-8 animate-spin text-gray-400"})])):(m(),y(ee,{key:1},[s(U)==="overview"?(m(),J(M,{key:0,state:s(r),"onUpdate:state":l[1]||(l[1]=k=>te(r)?r.value=k:null),onSave:G},null,8,["state"])):C("",!0),s(U)==="settings"?(m(),J(j,{key:1,state:s(r),"onUpdate:state":l[2]||(l[2]=k=>te(r)?r.value=k:null)},null,8,["state"])):C("",!0),s(U)==="worldbook"?(m(),J(n,{key:2,state:s(r),"onUpdate:state":l[3]||(l[3]=k=>te(r)?r.value=k:null)},null,8,["state"])):C("",!0),s(U)==="regex"?(m(),J(D,{key:3,state:s(r),"onUpdate:state":l[4]||(l[4]=k=>te(r)?r.value=k:null)},null,8,["state"])):C("",!0),s(U)==="quickreply"?(m(),J(d,{key:4,state:s(r),"onUpdate:state":l[5]||(l[5]=k=>te(r)?r.value=k:null)},null,8,["state"])):C("",!0),s(U)==="version"?(m(),J(a,{key:5,state:s(r),"onUpdate:state":l[6]||(l[6]=k=>te(r)?r.value=k:null),onPublish:S,onSwitchVersion:x},null,8,["state"])):C("",!0)],64))])])]),_:1})}}});export{Vr as default};
