import{_ as ne}from"./CEcF5dWm.js";import{f as ie,az as ve,c as G,i as R,ap as ke,j as de,aE as we,l as Z,a as Y,o as g,w as d,D as a,B as o,E as I,I as Ve,F as S,b as r,_ as X,k as f,G as L,H as D,n as ee,C as A,aq as ce,a4 as te,aT as Ce,aU as Ue,aF as C,z as Ae,A as ze,ax as $e}from"./DhOLkSnF.js";import{_ as Ne,a as Se,b as je,c as Oe}from"./DAqc9GYg.js";import{_ as Fe}from"./CSbqei5V.js";import{_ as Pe}from"./DAIKkUkW.js";import{_ as Ee}from"./DAeRr84W.js";import{_ as Je}from"./CVanS2c1.js";import{_ as Ie}from"./D0vBe5Vh.js";import{_ as Re}from"./Db__RPjw.js";import{_ as Te}from"./DEtjlJ-S.js";import{_ as Be}from"./BZLiX_8y.js";import{g as Ke,u as Le,a as Me,b as qe,r as Ge}from"./CxuEfYss.js";import{c as me}from"./45RcOEEf.js";import{o as De,s as oe,n as re}from"./B-mCBPct.js";import{u as He,b as Xe}from"./Bo5OMT4U.js";import{_ as H}from"./-rcGzxkB.js";import{_ as Qe}from"./CLU2_0cD.js";import{f as ae}from"./BmKy9gZZ.js";import{g as We}from"./D1QVHQma.js";import{u as Ye}from"./BVQSm7Ip.js";import"./CZg69nbc.js";import"./CwtpYSSp.js";import"./DPsBupTg.js";import"./9Rxep3Q5.js";import"./CLKxJTZi.js";import"./HRiyi1uV.js";import"./BrXYpapi.js";import"./BXSyqGa5.js";import"./CemQtCgh.js";function Ze(l){const p=atob(l),s=new Uint8Array(p.length);for(let u=0;u<p.length;u++)s[u]=p.charCodeAt(u);return s}function et(l){return new Promise((p,s)=>{const u=new FileReader;u.onload=()=>p(u.result),u.onerror=()=>s(new Error("读取文件失败")),u.readAsArrayBuffer(l)})}const tt=async l=>{const p=await et(l),s=new Uint8Array(p),u=[137,80,78,71,13,10,26,10];for(let w=0;w<8;w++)if(s[w]!==u[w])throw new Error("不是有效的 PNG 文件");const y="chara",_=new TextDecoder("utf-8");let m=8;for(;m+12<=s.length;){const w=(s[m]<<24|s[m+1]<<16|s[m+2]<<8|s[m+3])>>>0,b=String.fromCharCode(s[m+4],s[m+5],s[m+6],s[m+7]),$=m+8,O=$+w,P=O+4;if(O>s.length)break;if(b==="tEXt"){const j=s.slice($,O);let N=0;for(;N<j.length&&j[N]!==0;)N++;if(_.decode(j.slice(0,N))===y){const h=_.decode(j.slice(N+1));try{const F=Ze(h),e=new TextDecoder("utf-8").decode(F);return{charData:JSON.parse(e)}}catch(F){throw new Error(`不支持该角色卡导入：${F.message}`)}}}m=P}throw new Error("该图片不是角色卡")};function ot(l,p){if(!l||typeof l!="object")throw new Error("角色卡数据错误");const s=l.data||{},u=Array.isArray(l.tags)&&l.tags.length?l.tags:Array.isArray(s.tags)?s.tags:[],y=Array.isArray(l.alternate_greetings)&&l.alternate_greetings.length?l.alternate_greetings:Array.isArray(s.alternate_greetings)?s.alternate_greetings:[],_={id:`char_${Date.now()}`,fav:!1,spec:l.spec,spec_version:l.spec_version,name:l.name||s.name,anohana:{image:p,avatar:p},data:{name:l.name||s.name,description:l.description||s.description||"",personality:l.personality||s.personality||"",scenario:l.scenario||s.scenario||"",mes_example:l.mes_example||s.mes_example||"",creator_notes:l.creator_notes||s.creator_notes||"",system_prompt:l.system_prompt||s.system_prompt||"",post_history_instructions:l.post_history_instructions||s.post_history_instructions||"",creator:l.creator||s.creator||"",character_version:l.character_version||s.character_version||"",alternate_greetings:y,first_mes:l.first_mes||s.first_mes||"",tags:u,character_book:{},regex:[],regex_enabled:!1}};if(l.data&&typeof l.data=="object"&&(_.data={...s,character_book:s.character_book||{},regex:Array.isArray(s.regex)?s.regex:[],regex_enabled:!!s.regex_enabled,tags:Array.isArray(s.tags)?s.tags:u},_.tags=_.data.tags||u),s?.extensions?.regex_scripts&&(_.data.regex=s.extensions.regex_scripts,_.data.regex_enabled=!0),s?.character_book){const m={...s.character_book};console.log(m),Array.isArray(m.entries)&&(m.entries=m.entries.map(w=>{const b=w?.position;let $;return b===0||b==="0"?$="before_char":typeof b=="string"?$=b:$="after_char",{...w,position:$}})),_.data.character_book=m}return _}const rt={class:"border-b-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 px-6"},at={class:"flex gap-2"},st=["onClick"],lt={class:"p-6"},nt={key:0,class:"flex items-center justify-center py-20"},it={class:"text-center"},dt={key:1,class:"max-h-[60vh] overflow-y-auto pr-2"},ct={key:0,class:"space-y-4"},mt={class:"bg-gradient-to-br from-primary-50 to-blue-50 dark:from-primary-900/20 dark:to-blue-900/20 rounded-lg p-6 border border-primary-100 dark:border-primary-800"},ut={class:"flex items-start gap-4"},pt={class:"p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm"},gt={class:"flex-1"},ft={key:1},yt={class:"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-5 space-y-5"},bt={class:"flex items-center gap-2 mb-1"},_t={class:"grid grid-cols-2 gap-4"},xt={class:"grid grid-cols-2 gap-4"},ht={class:"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-5"},vt={class:"flex items-center gap-2 mb-4"},kt={class:"flex items-center gap-4"},wt={class:"relative group"},Vt={key:0,class:"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-full flex items-center justify-center"},Ct={class:"flex-1"},Ut={key:0,class:"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-5"},At={key:0,class:"flex items-center gap-2 text-red-600 dark:text-red-400 text-sm mt-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg"},zt={key:2,class:"space-y-4"},$t={class:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-5 border border-blue-100 dark:border-blue-800 mb-6"},Nt={class:"flex items-start gap-3"},St={class:"flex flex-col items-center justify-center min-w-[60px] pt-2"},jt={class:"w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center"},Ot={class:"font-bold text-primary-600 dark:text-primary-400"},Ft={class:"pt-4"},Pt={key:3,class:"space-y-5"},Et={class:"bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg p-5 border border-purple-100 dark:border-purple-800"},Jt={class:"flex items-start gap-3 mb-4"},It={class:"flex items-center justify-between"},Rt={class:"flex items-center gap-3"},Tt={class:"w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center"},Bt={class:"font-bold text-purple-600 dark:text-purple-400"},Kt={class:"font-medium text-gray-700 dark:text-gray-300"},Lt={class:"space-y-4"},Mt={class:"pt-4"},qt={key:4,class:"space-y-6"},Gt={class:"bg-gradient-to-br from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-lg p-5 border border-orange-100 dark:border-orange-800"},Dt={class:"flex items-start gap-3"},Ht={class:"flex-1"},Xt={class:"flex items-center gap-3 mt-4"},Qt={class:"text-gray-700 dark:text-gray-300 font-medium"},Wt={key:0,class:"space-y-4"},Yt={class:"flex items-center justify-between"},Zt={class:"flex items-center gap-3"},eo={class:"w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center"},to={class:"font-bold text-orange-600 dark:text-orange-400"},oo={class:"font-medium text-gray-700 dark:text-gray-300"},ro={key:1,class:"pt-4"},ao={class:"flex items-center justify-between w-full"},so={class:"text-sm text-gray-500 dark:text-gray-400"},lo={class:"flex gap-3"},no=ie({__name:"Edit",props:{dialog:{type:Boolean,default:!1},currentForm:{default:()=>({})},tagsOptions:{}},emits:["update:dialog","refresh","tags-options"],setup(l,{emit:p}){const s=ve(),u=G(()=>s.userInfo?.group_id===99),y=l,_=p,m=G({get(){return y.dialog},set(c){_("update:dialog",c)}}),w=()=>{m.value=!1},b=R("card"),$=G(()=>{const c=[["info","基础信息"],["dialogue","对话"],["world","世界书"],["regex","正则"]];return y.currentForm?.id||c.unshift(["card","角色卡"]),c}),O=ke("formRef"),P=R(),j=R(),N=R(),x=[{label:"原创",value:0},{label:"转载",value:1}],h=[{label:"隐私",value:2},{label:"公开",value:0}],F=[{label:"删除",value:4},{label:"待审核",value:1},{label:"正常",value:2},{label:"提交",value:0}],e=de({loading:!1,avatarLoading:!1,form:{tag:[],name:"",avatar:"",summary:"",description:"",first_mes:"",scenario:"",mes_example:"",personality:"",system_prompt:"",character_version:"",source_url:"",guide:"",character_book:{name:"",entries:[]},regex_enabled:!1,regex_rules:[],opening_lines:[]}}),M=De({anonymous:re(),source:re(),image:oe().nonempty(),source_url:oe().optional()}).refine(c=>!(c.source===1&&!c.source_url),{message:"转载时必须填写来源地址",path:["source_url"]}),z=we();function E(c={}){return{opening_lines:[],character_book:{name:"",entries:[]},regex_enabled:!1,regex_rules:[],...c}}async function Q(c){const t=c.target;if(t.files?.length&&Ce(t.files[0])){e.avatarLoading=!0;const{data:n}=await Ue({image:t.files[0]});n&&(e.form.image=n.uri),e.avatarLoading=!1}}function T(){P.value?.click()}async function ue(c){const t=c.target.files?.[0];if(t)try{e.avatarLoading=!0;const{charData:n}=await tt(t),v=ot(n,t);if(!v){z.add({title:"导入失败：无效的角色卡数据",color:"error"});return}Object.assign(e.form,v),b.value="info",z.add({title:"导入成功",color:"success"})}catch(n){console.error("导入 PNG 角色卡失败:",n),z.add({title:`导入失败：${n.message||"未知错误"}`,color:"error"})}finally{e.avatarLoading=!1;const n=c.target;n&&(n.value="")}}async function pe(c){const t=c.target.files?.[0];if(t)try{e.avatarLoading=!0;const n=await t.text(),v=JSON.parse(n);if(!v){z.add({title:"导入失败：无效的 JSON 数据",color:"error"});return}Object.assign(e.form,v),b.value="info",z.add({title:"导入成功",color:"success"})}catch(n){console.error("导入 JSON 失败:",n),z.add({title:`导入失败：${n.message||"JSON 格式错误"}`,color:"error"})}finally{e.avatarLoading=!1;const n=c.target;n&&(n.value="")}}const J=R(null),W=G({get(){try{const c=typeof e.form.body=="string"?JSON.parse(e.form.body):e.form.body;return JSON.stringify(c,null,2)}catch{return e.form.body}},set(c){e.form.body=c}});async function ge(){e.loading=!0;try{const c=me(e.form);Array.isArray(c.tag)&&(c.tag=c.tag.join(",")),c.source===0&&delete c.source_url;try{const n=JSON.parse(c.body);J.value=null,c.content=JSON.stringify(n)}catch(n){J.value=n.message,z.add({title:`JSON 格式错误: ${n.message}`,color:"error"});return}const{error:t}=await(c.id?Le:Me)(c);t||(z.add({title:"操作成功",color:"success"}),w(),_("refresh"))}finally{e.loading=!1}}const fe=[{label:"导入 PNG 角色卡",icon:"i-lucide-image",onSelect(){j.value?.click()}},{label:"导入 JSON",icon:"i-lucide-file-json",onSelect(){N.value?.click()}}];return Z(()=>y.dialog,async c=>{if(c){e.loading=!0,J.value=null;try{if(y.currentForm?.id){b.value="info";const{data:t,error:n}=await Ke({biz_id:y.currentForm.id});!n&&t?e.form=E(t.info):(e.form=E(y.currentForm),z.add({title:"获取详情失败",color:"error"}))}else b.value="card",e.form=E(y.currentForm)}catch{e.form=E(y.currentForm),z.add({title:"获取详情异常",color:"error"})}finally{e.loading=!1}}}),Z(()=>e.form.source,c=>{c===0&&(e.form.source_url="")}),(c,t)=>{const n=Ve,v=X,ye=ne,B=Pe,V=Ee,K=Je,q=Ie,be=ce,_e=Re,xe=Te,he=Be;return g(),Y(he,{open:r(m),"onUpdate:open":t[15]||(t[15]=i=>te(m)?m.value=i:null),title:r(e).form.id?"编辑":"新增",description:r(e).form.id?"编辑角色":"新增角色",dismissible:!1,ui:{content:"sm:max-w-4xl",body:"p-0",footer:"justify-end bg-gray-50 dark:bg-gray-900"}},{body:d(()=>[a("div",rt,[a("div",at,[(g(!0),f(L,null,D(r($),([i,k])=>(g(),f("button",{key:i,type:"button",class:ee(["px-5 py-3.5 text-sm transition-all relative rounded-t-lg",r(b)===i?"text-white dark:text-white font-bold bg-blue-400 dark:bg-blue-400 shadow-lg":"text-gray-600 dark:text-gray-400 font-medium hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-800"]),onClick:U=>b.value=i},S(k),11,st))),128))])]),a("div",lt,[r(e).loading?(g(),f("div",nt,[a("div",it,[o(n,{name:"i-material-symbols-progress-activity",class:"w-12 h-12 text-primary-500 animate-spin mx-auto"}),t[16]||(t[16]=a("p",{class:"mt-4 text-gray-600 dark:text-gray-400 font-medium"}," 加载中... ",-1))])])):(g(),f("div",dt,[r(b)==="card"?(g(),f("div",ct,[a("div",mt,[a("div",ut,[a("div",pt,[o(n,{name:"i-material-symbols-upload-file",class:"w-6 h-6 text-primary-600"})]),a("div",gt,[t[18]||(t[18]=a("h4",{class:"font-semibold text-gray-900 dark:text-white mb-1"}," 导入角色卡 ",-1)),t[19]||(t[19]=a("p",{class:"text-sm text-gray-600 dark:text-gray-400 mb-4"}," 支持导入 PNG 格式的角色卡或 JSON 配置文件 ",-1)),o(ye,{items:fe},{default:d(()=>[o(v,{loading:r(e).avatarLoading,"trailing-icon":"i-material-symbols-keyboard-arrow-down",size:"lg"},{leading:d(()=>[o(n,{name:"i-material-symbols-download"})]),default:d(()=>[t[17]||(t[17]=I(" 选择导入方式 ",-1))]),_:1},8,["loading"])]),_:1})])])]),a("input",{ref_key:"pngInputRef",ref:j,type:"file",class:"hidden",accept:".png",onChange:ue},null,544),a("input",{ref_key:"jsonInputRef",ref:N,type:"file",class:"hidden",accept:".json",onChange:pe},null,544)])):A("",!0),r(b)==="info"?(g(),f("div",ft,[o(_e,{ref_key:"formRef",ref:O,schema:r(M),state:r(e).form,class:"flex flex-col gap-5",onSubmit:ge},{default:d(()=>[a("div",yt,[a("div",bt,[o(n,{name:"i-material-symbols-info-outline",class:"w-5 h-5 text-primary-600"}),t[20]||(t[20]=a("h4",{class:"font-semibold text-gray-900 dark:text-white"}," 基本信息 ",-1))]),o(V,{label:"角色名",name:"name",required:""},{default:d(()=>[o(B,{modelValue:r(e).form.name,"onUpdate:modelValue":t[0]||(t[0]=i=>r(e).form.name=i),modelModifiers:{trim:!0},placeholder:"请输入角色名称",class:"w-full",type:"text",size:"lg"},{leading:d(()=>[o(n,{name:"i-material-symbols-person-outline",class:"w-5 h-5 text-gray-400"})]),_:1},8,["modelValue"])]),_:1}),o(V,{label:"前导词语",name:"guide",description:"角色对话的前导提示词，可选填"},{default:d(()=>[o(K,{modelValue:r(e).form.guide,"onUpdate:modelValue":t[1]||(t[1]=i=>r(e).form.guide=i),modelModifiers:{trim:!0},placeholder:"例如：你是一位友善的助手，擅长解答问题...",rows:3,class:"w-full",size:"lg"},null,8,["modelValue"])]),_:1}),a("div",_t,[o(V,{label:"来源",name:"source",required:""},{default:d(()=>[o(q,{modelValue:r(e).form.source,"onUpdate:modelValue":t[2]||(t[2]=i=>r(e).form.source=i),items:x,placeholder:"请选择",class:"w-full",size:"lg"},null,8,["modelValue"])]),_:1}),o(V,{label:"状态",name:"state",required:""},{default:d(()=>[o(q,{modelValue:r(e).form.state,"onUpdate:modelValue":t[3]||(t[3]=i=>r(e).form.state=i),items:F,placeholder:"请选择",class:"w-full",size:"lg"},null,8,["modelValue"])]),_:1})]),r(e).form.source===1?(g(),Y(V,{key:0,label:"来源地址",name:"source_url",description:"请输入转载来源的网址",required:""},{default:d(()=>[o(B,{modelValue:r(e).form.source_url,"onUpdate:modelValue":t[5]||(t[5]=i=>r(e).form.source_url=i),modelModifiers:{trim:!0},placeholder:"请输入来源地址，如：https://example.com",class:"w-full",type:"url",size:"lg"},{leading:d(()=>[o(n,{name:"i-material-symbols-link",class:"w-5 h-5 text-gray-400"})]),trailing:d(()=>[r(e).form.source_url?(g(),Y(v,{key:0,color:"neutral",variant:"link",size:"sm",icon:"i-material-symbols-close",onClick:t[4]||(t[4]=i=>r(e).form.source_url="")})):A("",!0)]),_:1},8,["modelValue"])]),_:1})):A("",!0),a("div",xt,[o(V,{label:"标签",name:"tag"},{default:d(()=>[o(q,{modelValue:r(e).form.tag,"onUpdate:modelValue":t[6]||(t[6]=i=>r(e).form.tag=i),items:l.tagsOptions,multiple:"",placeholder:"请选择标签",class:"w-full",clearable:"",size:"lg"},null,8,["modelValue","items"])]),_:1}),o(V,{label:"隐私",name:"anonymous",required:""},{default:d(()=>[o(q,{modelValue:r(e).form.anonymous,"onUpdate:modelValue":t[7]||(t[7]=i=>r(e).form.anonymous=i),items:h,placeholder:"请选择",class:"w-full",size:"lg"},null,8,["modelValue"])]),_:1})])]),a("div",ht,[a("div",vt,[o(n,{name:"i-material-symbols-image-outline",class:"w-5 h-5 text-primary-600"}),t[21]||(t[21]=a("h4",{class:"font-semibold text-gray-900 dark:text-white"}," 封面图片 ",-1))]),o(V,{name:"image",description:"JPG, JPEG or PNG. 1MB Max."},{default:d(()=>[a("div",kt,[a("div",wt,[o(be,{src:r(e).form.image,alt:r(e).form.name,size:"2xl",class:"ring-2 ring-gray-200 dark:ring-gray-700"},null,8,["src","alt"]),r(e).form.image?(g(),f("div",Vt,[o(n,{name:"i-material-symbols-edit",class:"w-6 h-6 text-white"})])):A("",!0)]),a("div",Ct,[o(v,{loading:r(e).avatarLoading,color:"neutral",variant:"outline",size:"lg",onClick:T},{leading:d(()=>[o(n,{name:"i-material-symbols-upload"})]),default:d(()=>[I(" "+S(r(e).form.image?"更换图片":"上传图片"),1)]),_:1},8,["loading"]),a("input",{ref_key:"fileRef",ref:P,type:"file",class:"hidden",accept:".jpg, .jpeg, .png",onChange:Q},null,544)])])]),_:1})]),r(u)?(g(),f("div",Ut,[o(V,{label:"角色数据 (JSON)",name:"content"},{default:d(()=>[o(K,{modelValue:r(W),"onUpdate:modelValue":t[8]||(t[8]=i=>te(W)?W.value=i:null),class:ee(["w-full font-mono text-sm",{"border-red-500 bg-red-50 dark:bg-red-900/20":r(J)}]),rows:12,placeholder:"请输入 JSON"},null,8,["modelValue","class"]),r(J)?(g(),f("div",At,[o(n,{name:"i-material-symbols-error-outline",class:"w-5 h-5"}),a("span",null,"JSON 错误: "+S(r(J)),1)])):A("",!0)]),_:1})])):A("",!0)]),_:1},8,["schema","state"])])):A("",!0),r(b)==="dialogue"?(g(),f("div",zt,[a("div",$t,[a("div",Nt,[o(n,{name:"i-material-symbols-chat-outline",class:"w-6 h-6 text-blue-600 mt-1"}),t[22]||(t[22]=a("div",null,[a("h4",{class:"font-semibold text-gray-900 dark:text-white mb-1"}," 开场对话配置 "),a("p",{class:"text-sm text-gray-600 dark:text-gray-400"}," 设置角色的开场白和初始对话内容 ")],-1))])]),(g(!0),f(L,null,D(r(e).form.opening_lines,(i,k)=>(g(),f("div",{key:k,class:"group rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 flex gap-4 hover:border-primary-300 dark:hover:border-primary-700 hover:shadow-md transition-all"},[a("div",St,[a("div",jt,[a("span",Ot,S(Number(k)+1),1)]),t[23]||(t[23]=a("span",{class:"text-xs text-gray-500 dark:text-gray-400 mt-2"},"对话",-1))]),o(K,{modelValue:r(e).form.opening_lines[k],"onUpdate:modelValue":U=>r(e).form.opening_lines[k]=U,placeholder:"请输入对话内容...",class:"flex-1",rows:4,size:"lg"},null,8,["modelValue","onUpdate:modelValue"]),o(v,{icon:"i-material-symbols-delete-outline",color:"error",variant:"ghost",size:"lg",class:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:U=>r(e).form.opening_lines.splice(k,1)},null,8,["onClick"])]))),128)),a("div",Ft,[o(v,{variant:"outline",color:"primary",size:"lg",block:"",onClick:t[9]||(t[9]=i=>r(e).form.opening_lines.push(""))},{leading:d(()=>[o(n,{name:"i-material-symbols-add-circle-outline"})]),default:d(()=>[t[24]||(t[24]=I(" 新增对话 ",-1))]),_:1})])])):A("",!0),r(b)==="world"?(g(),f("div",Pt,[a("div",Et,[a("div",Jt,[o(n,{name:"i-material-symbols-public",class:"w-6 h-6 text-purple-600 mt-1"}),t[25]||(t[25]=a("div",null,[a("h4",{class:"font-semibold text-gray-900 dark:text-white mb-1"}," 世界观设定 "),a("p",{class:"text-sm text-gray-600 dark:text-gray-400"}," 定义角色所处的世界背景和设定 ")],-1))]),o(V,{label:"世界书名称"},{default:d(()=>[o(B,{modelValue:r(e).form.character_book.name,"onUpdate:modelValue":t[10]||(t[10]=i=>r(e).form.character_book.name=i),placeholder:"例如：中世纪魔法世界",size:"lg",class:"w-full"},{leading:d(()=>[o(n,{name:"i-material-symbols-book-outline",class:"w-5 h-5 text-gray-400"})]),_:1},8,["modelValue"])]),_:1})]),(g(!0),f(L,null,D(r(e).form.character_book.entries,(i,k)=>(g(),f("div",{key:k,class:"rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 space-y-4 hover:border-purple-300 dark:hover:border-purple-700 hover:shadow-md transition-all"},[a("div",It,[a("div",Rt,[a("div",Tt,[a("span",Bt,S(Number(k)+1),1)]),a("span",Kt,"条目 "+S(Number(k)+1),1)]),o(v,{icon:"i-material-symbols-delete-outline",size:"md",variant:"ghost",color:"error",onClick:U=>r(e).form.character_book.entries.splice(k,1)},null,8,["onClick"])]),a("div",Lt,[o(V,{label:"触发关键词"},{default:d(()=>[o(B,{modelValue:i.keys[0],"onUpdate:modelValue":U=>i.keys[0]=U,placeholder:"请输入触发关键词",class:"w-full",size:"lg"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(V,{label:"内容"},{default:d(()=>[o(K,{modelValue:i.content,"onUpdate:modelValue":U=>i.content=U,placeholder:"请输入详细内容...",rows:5,class:"w-full",size:"lg"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)])]))),128)),a("div",Mt,[o(v,{variant:"outline",color:"primary",size:"lg",block:"",onClick:t[11]||(t[11]=i=>r(e).form.character_book.entries.push({keys:[""],content:"",enabled:!0,insertion_order:0}))},{leading:d(()=>[o(n,{name:"i-material-symbols-add-circle-outline"})]),default:d(()=>[t[26]||(t[26]=I(" 新增条目 ",-1))]),_:1})])])):A("",!0),r(b)==="regex"?(g(),f("div",qt,[a("div",Gt,[a("div",Dt,[o(n,{name:"i-material-symbols-regular-expression",class:"w-6 h-6 text-orange-600 mt-1"}),a("div",Ht,[t[27]||(t[27]=a("h4",{class:"font-semibold text-gray-900 dark:text-white mb-1"}," 正则表达式回复 ",-1)),t[28]||(t[28]=a("p",{class:"text-sm text-gray-600 dark:text-gray-400 mb-4"}," 使用正则表达式匹配特定内容并自动回复 ",-1)),a("div",Xt,[o(xe,{modelValue:r(e).form.regex_enabled,"onUpdate:modelValue":t[12]||(t[12]=i=>r(e).form.regex_enabled=i),size:"lg"},null,8,["modelValue"]),a("span",Qt,S(r(e).form.regex_enabled?"已启用":"已禁用"),1)])])])]),r(e).form.regex_enabled?(g(),f("div",Wt,[(g(!0),f(L,null,D(r(e).form.regex_rules,(i,k)=>(g(),f("div",{key:k,class:"rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 space-y-4 hover:border-orange-300 dark:hover:border-orange-700 hover:shadow-md transition-all"},[a("div",Yt,[a("div",Zt,[a("div",eo,[a("span",to,S(Number(k)+1),1)]),a("span",oo,"规则 "+S(Number(k)+1),1)]),o(v,{icon:"i-material-symbols-delete-outline",size:"md",variant:"ghost",color:"error",onClick:U=>r(e).form.regex_rules.splice(k,1)},null,8,["onClick"])]),o(V,{label:"正则表达式"},{default:d(()=>[o(B,{modelValue:i.pattern,"onUpdate:modelValue":U=>i.pattern=U,placeholder:"例如：^hello|你好",class:"w-full font-mono",size:"lg"},{leading:d(()=>[o(n,{name:"i-material-symbols-code",class:"w-5 h-5 text-gray-400"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(V,{label:"回复内容"},{default:d(()=>[o(K,{modelValue:i.reply,"onUpdate:modelValue":U=>i.reply=U,placeholder:"匹配成功后的回复内容...",rows:3,class:"w-full",size:"lg"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]))),128))])):A("",!0),r(e).form.regex_enabled?(g(),f("div",ro,[o(v,{variant:"outline",color:"primary",size:"lg",block:"",onClick:t[13]||(t[13]=i=>r(e).form.regex_rules.push({pattern:"",reply:""}))},{leading:d(()=>[o(n,{name:"i-material-symbols-add-circle-outline"})]),default:d(()=>[t[29]||(t[29]=I(" 新增规则 ",-1))]),_:1})])):A("",!0)])):A("",!0)]))])]),footer:d(()=>[a("div",ao,[a("div",so,[o(n,{name:"i-material-symbols-info-outline",class:"inline w-4 h-4"}),I(" "+S(r(e).form.id?"修改后将更新角色信息":"确认后将创建新角色"),1)]),a("div",lo,[o(v,{label:"取消",color:"neutral",variant:"outline",size:"lg",onClick:w},{leading:d(()=>[o(n,{name:"i-material-symbols-close"})]),_:1}),o(v,{loading:r(e).loading,label:"确认保存",variant:"solid",size:"lg",onClick:t[14]||(t[14]=i=>r(O)?.submit())},{leading:d(()=>[o(n,{name:"i-material-symbols-check"})]),_:1},8,["loading"])])])]),_:1},8,["open","title","description"])}}}),io=Object.assign(no,{__name:"AmusementListEdit"}),co={0:["提交","info"],1:["待审核","warning"],2:["启用","success"],4:["已删除","error"]},se={2:["是","success"],0:["否","error"]},le={2:["隐私","success"],0:["公开","info"]},mo=l=>{const p=document.createElement("div");p.className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center cursor-pointer",p.onclick=()=>p.remove();const s=document.createElement("div");s.className="relative max-w-[90vw] max-h-[90vh] p-4";const u=document.createElement("button");u.innerHTML="✕",u.className="absolute -top-2 -right-2 w-8 h-8 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-xl font-bold z-10 text-gray-900 dark:text-white",u.onclick=_=>{_.stopPropagation(),p.remove()};const y=document.createElement("img");y.src=l,y.className="max-w-full max-h-[85vh] rounded-lg shadow-2xl",y.onclick=_=>_.stopPropagation(),s.appendChild(u),s.appendChild(y),p.appendChild(s),document.body.appendChild(p)},uo=[{accessorKey:"id",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},header:()=>C(X,{color:"neutral",variant:"ghost",label:"ID",class:"-mx-2.5 hover:bg-transparent focus:bg-transparent data-[state=open]:bg-transparent"})},{accessorKey:"image",header:"封面图",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},cell:({row:l})=>{const p=l.original.image;return p?C("div",{class:"cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mo(p)},[C(ce,{src:p,alt:"卡片封面图",size:"lg",class:"ring-1 ring-gray-200 dark:ring-gray-700"})]):C("div",{class:"w-10 h-10 rounded bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400"},"N/A")}},{accessorKey:"name",searchPlaceholder:"筛选名称",header:"卡片名称",meta:{class:{th:"w-[150px]",td:"w-[150px]"}},cell:({row:l})=>C(Qe,{text:l.original.name},{default:()=>C("div",{class:"space-y-0.5 cursor-help"},[C("p",{class:"font-medium truncate text-gray-900 dark:text-white"},l.original.name),C(H,{size:"xs",color:"neutral",variant:"soft"},()=>`作者： ${l.original.member?.username||"-"}`)])})},{accessorKey:"battery",header:"已获电量",meta:{class:{th:"w-[100px]",td:"w-[100px]"}}},{accessorKey:"collect_count",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},header:"收藏数"},{accessorKey:"comment_count",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},header:"评论数"},{accessorKey:"score",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},header:"评分"},{accessorKey:"score_count",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},header:"评分人数"},{accessorKey:"word_count",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},header:"字数"},{accessorKey:"created_at",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},header:"创建时间",cell:({row:l})=>ae(l.original.created_at)},{accessorKey:"updated_at",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},header:"更新时间",cell:({row:l})=>ae(l.original.updated_at)},{accessorKey:"anonymous",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},header:"是否隐私",searchPlaceholder:"隐私筛选",formItemProps:{component:"Select",componentProps:{options:[{label:"隐私",value:2},{label:"公开",value:0}]}},cell:({row:l})=>C(H,{class:"capitalize",variant:"subtle",color:le[l.original.anonymous]?.[1]},()=>le[l.original.anonymous]?.[0])},{accessorKey:"day_recommend",meta:{class:{th:"w-[100px]",td:"w-[100px]"}},header:"是否日推",searchPlaceholder:"筛选状态",formItemProps:{component:"Select",componentProps:{options:[{label:"是",value:2},{label:"否",value:0}]}},cell:({row:l})=>C(H,{class:"capitalize",variant:"subtle",color:se[l.original.day_recommend]?.[1]},()=>se[l.original.day_recommend]?.[0])},{accessorKey:"state",meta:{class:{th:"w-[100px]",td:"w-[80px]"}},header:"状态",searchPlaceholder:"筛选状态",formItemProps:{component:"Select",componentProps:{options:[{label:"待审核",value:1},{label:"正常",value:2},{label:"已删除",value:4},{label:"提交",value:0}]}},cell:({row:l})=>{const p=l.original.state,[s,u]=co[p]||["未知","neutral"];return C(H,{class:"capitalize",variant:"subtle",color:u},()=>s)}}],po={key:0,class:"absolute top-0 left-0 right-0 h-(--ui-header-height) flex items-center justify-between border-b border-(--ui-border) px-4 sm:px-6 bg-(--ui-bg)"},go={class:"flex items-center gap-4"},Mo=ie({name:"AmusementList",__name:"list",setup(l){const s=He(Xe).smaller("lg"),u=R(),y=X,_=Ye(),m=de({isDialog:!1,currentForm:{},tagsOptions:[]}),w=async x=>{m.isDialog=!0,x?m.currentForm=me(x):m.currentForm={state:2}},b=async()=>{u.value.reload(),m.isDialog=!1},$=async x=>{const{error:h}=await Ge({id:x.id});h||u.value.reload()},O=async()=>{const{data:x}=await We({page:1,pagesize:-1,ty:"1"});x?m.tagsOptions=x.list.map(h=>({label:h.name,value:h.name})):m.tagsOptions=[]};function P(x){const h=$e();return[{label:"编辑",icon:"material-symbols:edit-square-outline",onSelect(){w(x.original)}},{type:"separator"},{label:"查看评论",icon:"material-symbols:visibility-outline",onSelect(){h.push(`/amusement/comment/${x.original.id}`)}},{type:"separator"},{label:"删除",icon:"material-symbols:contract-delete-outline-rounded",color:"error",onSelect(){_.open({color:"error",title:"删除数据",description:"您确定要删除吗？",onPositiveClick(){$(x.original)}})}}]}const j=[...uo,{id:"actions",meta:{class:{th:"w-[80px]",td:"w-[80px]"}},cell:({row:x})=>C("div",{class:"text-right"},C(ne,{content:{align:"end"},items:P(x)},()=>C(X,{icon:"i-lucide-ellipsis-vertical",color:"neutral",variant:"ghost",class:"ml-auto"})))}],N=()=>{O()};return Ae(()=>{N()}),(x,h)=>{const F=Se,e=Ne,M=je,z=Fe,E=Oe,Q=io;return g(),f(L,null,[o(E,{ui:{body:"pb-[12px]! gap-0!"}},ze({body:d(()=>[r(s)?A("",!0):(g(),f("div",po,[a("div",go,[o(F),o(M)]),o(r(y),{label:"新增",icon:"i-lucide-plus",onClick:h[1]||(h[1]=T=>w(null))})])),o(z,{ref_key:"tableRef",ref:u,"data-request":r(qe),columns:j,"scroll-x":"min-w-[1000px]"},null,8,["data-request"])]),_:2},[r(s)?{name:"header",fn:d(()=>[o(e,{title:"卡片列表"},{leading:d(()=>[o(F)]),right:d(()=>[o(r(y),{label:"新增",icon:"i-lucide-plus",onClick:h[0]||(h[0]=T=>w(null))})]),_:1})]),key:"0"}:void 0]),1024),o(Q,{dialog:r(m).isDialog,"onUpdate:dialog":h[2]||(h[2]=T=>r(m).isDialog=T),"current-form":r(m).currentForm,"tags-options":r(m).tagsOptions,onRefresh:b},null,8,["dialog","current-form","tags-options"])],64)}}});export{Mo as default};
